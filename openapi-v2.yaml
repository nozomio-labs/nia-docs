openapi: 3.1.0
info:
  title: Nia AI API
  version: '2.2.0'
  description: |
    Nia AI API provides a single, consistent `sources` resource for all indexed content.

    ## Core Resources

    **Sources** (`/sources`)
    - `repository`
    - `documentation`
    - `research_paper`
    - `huggingface_dataset`
    - `local_folder`

    **Search** (`/search`)
    - `mode`: query | web | deep | universal

    Legacy endpoints are deprecated and will be removed in a future version. Prefer `/sources` and `/search` for new integrations.
  
servers:
  - url: https://apigcp.trynia.ai/v2
    description: Production API
  - url: http://localhost:8000/v2
    description: Local development

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: API key must be provided in the Authorization header

  schemas:
    SourceType:
      type: string
      enum: [repository, documentation, research_paper, huggingface_dataset, local_folder]
      description: Unified source type

    Pagination:
      type: object
      required: [total, limit, offset, has_more]
      properties:
        total:
          type: integer
          description: Total number of items
        limit:
          type: integer
          description: Items per page
        offset:
          type: integer
          description: Current offset
        has_more:
          type: boolean
          description: Whether more items exist

    Source:
      type: object
      required: [id, type]
      properties:
        id:
          type: string
          description: Source identifier
        type:
          $ref: '#/components/schemas/SourceType'
        identifier:
          type: string
          description: Canonical identifier (repo slug, URL, or folder path)
        display_name:
          type: string
          description: Human-readable name
        status:
          type: string
          description: Indexing status
        created_at:
          type: string
          description: Creation timestamp (ISO)
        updated_at:
          type: string
          description: Last update timestamp (ISO)
        category_id:
          type: string
          nullable: true
          description: Category assignment
        is_global:
          type: boolean
          description: Whether the source is global/shared
        global_source_id:
          type: string
          nullable: true
          description: Global source ID if applicable
        global_namespace:
          type: string
          nullable: true
          description: Global namespace if applicable
        metadata:
          type: object
          description: Type-specific metadata
          additionalProperties: true

    SourceListResponse:
      type: object
      required: [items, pagination]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Source'
        pagination:
          $ref: '#/components/schemas/Pagination'

    LocalFolderFile:
      type: object
      required: [path, content]
      properties:
        path:
          type: string
        content:
          type: string

    DatabaseFile:
      type: object
      required: [filename, content]
      properties:
        filename:
          type: string
        content:
          type: string
          description: Base64-encoded content

    SourceCreateRequest:
      type: object
      required: [type]
      properties:
        type:
          $ref: '#/components/schemas/SourceType'
        repository:
          type: string
          description: Repository slug (owner/repo)
        branch:
          type: string
        ref:
          type: string
          description: Git ref to index (branch, tag, or commit SHA). Takes precedence over branch.
        url:
          type: string
          description: Documentation or dataset URL
        folder_name:
          type: string
        folder_path:
          type: string
        files:
          type: array
          items:
            $ref: '#/components/schemas/LocalFolderFile'
        database:
          $ref: '#/components/schemas/DatabaseFile'
        add_as_global_source:
          type: boolean
          default: true
        url_patterns:
          type: array
          items:
            type: string
        exclude_patterns:
          type: array
          items:
            type: string
        limit:
          type: integer
        max_depth:
          type: integer
        wait_for:
          type: integer
        is_pdf:
          type: boolean
        display_name:
          type: string
        focus_instructions:
          type: string

    SourceUpdateRequest:
      type: object
      properties:
        display_name:
          type: string
        category_id:
          type: string
          nullable: true

    SourceDeleteResponse:
      type: object
      required: [id, status]
      properties:
        id:
          type: string
        status:
          type: string

    SourceResolveResponse:
      type: object
      required: [id, type]
      properties:
        id:
          type: string
        type:
          $ref: '#/components/schemas/SourceType'
        display_name:
          type: string
        identifier:
          type: string

    QuerySearchRequest:
      allOf:
        - $ref: '#/components/schemas/QueryRequest'
        - type: object
          required: [mode]
          properties:
            mode:
              type: string
              enum: [query]

    WebSearchRequestWithMode:
      allOf:
        - $ref: '#/components/schemas/WebSearchRequest'
        - type: object
          required: [mode]
          properties:
            mode:
              type: string
              enum: [web]

    DeepResearchRequestWithMode:
      allOf:
        - $ref: '#/components/schemas/DeepResearchRequest'
        - type: object
          required: [mode]
          properties:
            mode:
              type: string
              enum: [deep]

    UniversalSearchRequestWithMode:
      allOf:
        - $ref: '#/components/schemas/UniversalSearchRequest'
        - type: object
          required: [mode]
          properties:
            mode:
              type: string
              enum: [universal]

    SearchRequest:
      oneOf:
        - $ref: '#/components/schemas/QuerySearchRequest'
        - $ref: '#/components/schemas/WebSearchRequestWithMode'
        - $ref: '#/components/schemas/DeepResearchRequestWithMode'
        - $ref: '#/components/schemas/UniversalSearchRequestWithMode'
      discriminator:
        propertyName: mode
        mapping:
          query: '#/components/schemas/QuerySearchRequest'
          web: '#/components/schemas/WebSearchRequestWithMode'
          deep: '#/components/schemas/DeepResearchRequestWithMode'
          universal: '#/components/schemas/UniversalSearchRequestWithMode'
    RepositoryRequest:
      type: object
      required:
        - repository
      properties:
        repository:
          type: string
          description: Repository identifier in owner/repo format or full GitHub URL (supports folder paths like owner/repo/tree/branch/folder)
          example: "microsoft/vscode"
        branch:
          type: string
          description: Branch to index (defaults to repository's default branch)
          example: "main"
        ref:
          type: string
          description: Git ref to index (branch, tag, or commit SHA). Takes precedence over branch.
          example: "v1.2.3"

    QueryRequest:
      type: object
      required:
        - messages
      properties:
        messages:
          type: array
          items:
            type: object
            required:
              - role
              - content
            properties:
              role:
                type: string
                enum: [user, assistant]
              content:
                type: string
          description: Chat messages for context and query
          example:
            - role: user
              content: "How does the error handling work in this codebase?"
        repositories:
          type: array
          items:
            type: object
            required:
              - repository
            properties:
              repository:
                type: string
                description: Repository identifier in owner/repo format or owner/repo/tree/branch/folder for folder-indexed repos
          description: List of repositories to query
        data_sources:
          type: array
          items:
            oneOf:
              - type: string
                description: |
                  Flexible data source identifier (recommended). Can be:
                  - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
                  - Display name (e.g., "Vercel AI SDK - Core", "openai/gsm8k")
                  - URL (e.g., "https://docs.trynia.ai/", "https://arxiv.org/abs/2312.00752")
              - type: object
                required:
                  - source_id
                properties:
                  source_id:
                    type: string
                    description: Data source UUID identifier (legacy format)
              - type: object
                required:
                  - identifier
                properties:
                  identifier:
                    type: string
                    description: Flexible data source identifier
          description: |
            List of data sources to query. **Supports all source types:**
            - Documentation/websites
            - Research papers (arXiv)
            - HuggingFace datasets

            Flexible identifier formats:
            - String (recommended): ["Vercel AI SDK - Core", "openai/gsm8k", "https://arxiv.org/abs/2312.00752"]
            - Legacy object: [{"source_id": "uuid"}]
            - New object: [{"identifier": "display-name-or-url"}]
        search_mode:
          type: string
          enum: [repositories, sources, unified]
          default: unified
          description: |
            Search mode:
            - 'unified': Smart routing based on provided sources (default)
            - 'repositories': Search GitHub repositories only
            - 'sources': Search data sources only (documentation, research papers, HuggingFace datasets, local folders)
        stream:
          type: boolean
          default: false
          description: Whether to stream the response
        include_sources:
          type: boolean
          default: true
          description: Whether to include full source texts in the response (when false, only file paths are returned)
        local_folders:
          type: array
          items:
            oneOf:
              - type: string
                description: Local folder identifier (UUID or display name)
              - type: object
                required:
                  - local_folder_id
                properties:
                  local_folder_id:
                    type: string
                    description: Local folder UUID identifier
              - type: object
                required:
                  - identifier
                properties:
                  identifier:
                    type: string
                    description: Flexible local folder identifier (display name or UUID)
          description: |
            List of local folders to query. Local folders are private and user-scoped.

            Flexible identifier formats:
            - String (recommended): ["folder-uuid", "My Notes"]
            - Object: [{"local_folder_id": "uuid"}] or [{"identifier": "display-name"}]
        category:
          type: string
          description: Filter local folder results by classification category (e.g., "Work", "Personal")

    RepositoryStatus:
      type: object
      required:
        - repository
        - branch
        - status
      properties:
        repository:
          type: string
          description: Repository identifier
        branch:
          type: string
          description: Branch being indexed
        status:
          type: string
          enum: [indexing, completed, indexed, error]
          description: Current indexing status
        progress:
          type: object
          description: Detailed progress information
          properties:
            percentage:
              type: number
              description: Progress percentage (0-100)
            stage:
              type: string
              description: Current stage of indexing
            message:
              type: string
              description: Progress message
        error:
          type: string
          description: Error message if status is 'error'

    RepositoryListItem:
      type: object
      properties:
        repository_id:
          type: string
          description: Unique identifier for the repository
        id:
          type: string
          description: Internal project ID for graph visualization
        repository:
          type: string
          description: Repository identifier in owner/repo format
        branch:
          type: string
          description: Indexed branch
        status:
          type: string
          enum: [indexing, indexed, completed, error]
        display_name:
          type: string
          description: Custom display name for the repository
        progress:
          type: object
          properties:
            percentage:
              type: number
            stage:
              type: string
            message:
              type: string
        error:
          type: string
          description: Error message if status is 'error'

    RenameRequest:
      type: object
      required:
        - new_name
      properties:
        new_name:
          type: string
          minLength: 1
          maxLength: 100
          description: New display name for the resource

    RenameRequestWithIdentifier:
      type: object
      required:
        - identifier
        - new_name
      properties:
        identifier:
          type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core")
            - URL (e.g., "https://docs.trynia.ai/")
        new_name:
          type: string
          minLength: 1
          maxLength: 100
          description: New display name for the resource

    WebSearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Search query
          example: "best practices for React hooks"
        num_results:
          type: integer
          minimum: 1
          maximum: 10
          default: 5
          description: Number of results to return
        category:
          type: string
          enum: [github, company, research, news, tweet, pdf, blog]
          description: Filter by content category
        days_back:
          type: integer
          description: Only show results from last N days
        find_similar_to:
          type: string
          format: uri
          description: URL to find similar content to

    WebSearchResponse:
      type: object
      properties:
        github_repos:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
              owner_repo:
                type: string
              title:
                type: string
              summary:
                type: string
              highlights:
                type: array
                items:
                  type: string
              published_date:
                type: string
        documentation:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
              title:
                type: string
              summary:
                type: string
              highlights:
                type: array
                items:
                  type: string
        other_content:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
              title:
                type: string
              summary:
                type: string
        total_results:
          type: integer

    DeepResearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Research question for deep analysis
          example: "Compare the top 3 state management solutions for React with pros and cons"
        output_format:
          type: string
          description: Optional structure hint for the output (e.g., 'comparison table', 'pros and cons list')
        verbose:
          type: boolean
          default: false
          description: Include verbose trace output

    DeepResearchResponse:
      type: object
      properties:
        data:
          type: object
          description: Structured research data based on the query
        citations:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
              title:
                type: string
              snippet:
                type: string
          description: Sources cited in the research
        status:
          type: string
          enum: [completed, failed]
        trace:
          type: array
          description: Verbose trace events
          items:
            type: object

    UniversalSearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Natural language search query
          example: "How does authentication work in FastAPI?"
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Total number of results to return
        include_repos:
          type: boolean
          default: true
          description: Include repository sources in search
        include_docs:
          type: boolean
          default: true
          description: Include documentation sources in search
        include_huggingface_datasets:
          type: boolean
          default: false
          description: Include HuggingFace dataset sources in search (excluded by default to prevent search pollution)
        alpha:
          type: number
          minimum: 0.0
          maximum: 1.0
          default: 0.7
          description: Weight for vector search (1-alpha for BM25). Higher values favor semantic similarity.
        compress_output:
          type: boolean
          default: false
          description: Use AI to compress results into a concise answer with citations
        max_tokens:
          type: integer
          minimum: 100
          maximum: 100000
          nullable: true
          description: Maximum tokens in response. Results truncated when budget reached.
        boost_source_types:
          type: object
          additionalProperties:
            type: number
          default:
            repository: 1.2
            documentation: 1.0
            research_paper: 0.9
            huggingface_dataset: 0.85
          description: Source type boosts (override to customize or set {} to disable)
        boost_languages:
          type: array
          items:
            type: string
          nullable: true
          description: Programming languages to boost (e.g., ['python', 'typescript'])
        language_boost_factor:
          type: number
          minimum: 1.0
          maximum: 5.0
          default: 1.5
          description: Boost multiplier for preferred languages
        use_native_boosting:
          type: boolean
          default: true
          description: Use TurboPuffer FTS v2 native Sum/Product boosting
        expand_symbols:
          type: boolean
          default: false
          description: Extract function/class names from results and search for usages (cAST-inspired symbol expansion)

    UniversalSearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              content:
                type: string
                description: Text content of the search result
              summary:
                type: string
                nullable: true
                description: Extractive summary of the chunk (REFRAG-inspired)
              score:
                type: number
                description: Relevance score (higher is better)
              confidence:
                type: number
                minimum: 0
                maximum: 1
                description: Normalized confidence score 0-1
              source:
                type: object
                properties:
                  type:
                    type: string
                    enum: [repository, documentation, research_paper, huggingface_dataset]
                    description: Type of source
                  url:
                    type: string
                    description: URL of the source
                  namespace:
                    type: string
                    description: Namespace identifier
                  file_path:
                    type: string
                    description: File path within the source (if applicable)
                  display_name:
                    type: string
                    description: Human-readable name of the source
        sources_searched:
          type: integer
          description: Number of source namespaces searched
        query_time_ms:
          type: integer
          description: Total query time in milliseconds
        errors:
          type: array
          items:
            type: string
          nullable: true
          description: Any errors encountered during search
        answer:
          type: string
          nullable: true
          description: AI-compressed answer (only when compress_output=true)
        token_metadata:
          $ref: '#/components/schemas/TokenMetadata'

    UsageSummaryResponse:
      type: object
      properties:
        user_id:
          type: string
          description: User identifier
        organization_id:
          type: string
          nullable: true
          description: Organization identifier (if applicable)
        subscription_tier:
          type: string
          enum: [free, pro, enterprise]
          description: Current subscription tier
        billing_period_start:
          type: string
          format: date-time
          description: Start of current billing period
        billing_period_end:
          type: string
          format: date-time
          description: End of current billing period
        usage:
          type: object
          additionalProperties:
            type: object
            properties:
              used:
                type: integer
                description: Number of operations used this period
              limit:
                type: integer
                description: Maximum allowed operations (0 if unlimited)
              unlimited:
                type: boolean
                description: Whether this operation type is unlimited
          description: Usage breakdown by operation type

    SourceContentRequest:
      type: object
      required:
        - source_type
        - source_identifier
      properties:
        source_type:
          type: string
          enum: [repository, documentation]
          description: Type of source to retrieve
        source_identifier:
          type: string
          description: |
            Identifier for the source:
            - For repositories: 'owner/repo:path/to/file' (e.g., 'facebook/react:src/React.js')
            - For documentation: The source URL
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata from search results to help locate the source

    SourceContentResponse:
      type: object
      properties:
        success:
          type: boolean
        content:
          type: string
          description: Full content of the source file or document
        metadata:
          type: object
          properties:
            repository:
              type: string
            file_path:
              type: string
            branch:
              type: string
            language:
              type: string
            url:
              type: string
            title:
              type: string
            source_type:
              type: string
        error:
          type: string
          description: Error message if retrieval failed

    PackageSearchGrepRequest:
      type: object
      required:
        - registry
        - package_name
        - pattern
      properties:
        registry:
          type: string
          enum: [crates_io, golang_proxy, npm, py_pi]
          description: Package registry to search
          example: "npm"
        package_name:
          type: string
          description: Name of the package to search
          example: "react"
        pattern:
          type: string
          description: Regex pattern to search for in the package source code
          example: "useState|useEffect"
        version:
          type: string
          description: Specific version to search (optional, defaults to latest)
          example: "18.2.0"
        language:
          type: string
          description: Language filter for search results
          example: "TypeScript"
        filename_sha256:
          type: string
          description: SHA256 hash of specific file to search in
        a:
          type: integer
          description: Number of lines after each match to include
        b:
          type: integer
          description: Number of lines before each match to include
        c:
          type: integer
          description: Number of lines before and after each match to include
        head_limit:
          type: integer
          description: Maximum number of results to return
          example: 10
        output_mode:
          type: string
          enum: [content, files_with_matches, count]
          default: content
          description: Format of the output results

    PackageSearchHybridRequest:
      type: object
      required:
        - registry
        - package_name
        - semantic_queries
      properties:
        registry:
          type: string
          enum: [crates_io, golang_proxy, npm, py_pi]
          description: Package registry to search
          example: "npm"
        package_name:
          type: string
          description: Name of the package to search
          example: "react"
        semantic_queries:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 5
          description: 1-5 semantic queries about the codebase
          example: ["How does React handle state updates?", "What are the main hooks available?"]
        version:
          type: string
          description: Specific version to search (optional, defaults to latest)
          example: "18.2.0"
        filename_sha256:
          type: string
          description: SHA256 hash of specific file to search in
        pattern:
          type: string
          description: Optional regex pattern for pre-filtering results
        language:
          type: string
          description: Language filter for search results
          example: "TypeScript"

    PackageSearchReadFileRequest:
      type: object
      required:
        - registry
        - package_name
        - filename_sha256
        - start_line
        - end_line
      properties:
        registry:
          type: string
          enum: [crates_io, golang_proxy, npm, py_pi]
          description: Package registry containing the file
          example: "npm"
        package_name:
          type: string
          description: Name of the package containing the file
          example: "react"
        filename_sha256:
          type: string
          description: SHA256 hash of the file to read (obtained from grep/hybrid search)
          example: "a1b2c3d4e5f6..."
        start_line:
          type: integer
          minimum: 1
          description: Starting line number (1-based, inclusive)
          example: 1
        end_line:
          type: integer
          minimum: 1
          description: Ending line number (1-based, inclusive)
          example: 100
        version:
          type: string
          description: Specific version of the package (optional, defaults to latest)
          example: "18.2.0"

    PackageSearchResponse:
      type: object
      description: Raw response from Chroma Package Search API
      properties:
        version_used:
          type: string
          description: Version of the package that was searched
          example: "18.2.0"
        results:
          type: array
          description: Search results from the package
          items:
            type: object
            description: Search result item (format varies by search type)
        truncation_message:
          type: string
          description: Message indicating if results were truncated

    DataSourceRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
          description: URL to index (documentation or website)
          example: "https://docs.example.com"
        url_patterns:
          type: array
          items:
            type: string
          description: URL patterns to include in crawling (supports wildcards)
          example: ["https://docs.example.com/api/*", "https://docs.example.com/guides/*"]
        exclude_patterns:
          type: array
          items:
            type: string
          description: URL patterns to exclude from crawling
          example: ["/blog/*", "/changelog/*"]
        project_id:
          type: string
          description: Optional project ID to associate with
        max_age:
          type: integer
          description: Maximum age of cached content in seconds (for fast scraping)
        formats:
          type: array
          items:
            type: string
          description: Content formats to return
          example: ["markdown", "html"]
        only_main_content:
          type: boolean
          default: false
          description: Extract only main content (False recommended for JS-heavy/SPA sites)
        limit:
          type: integer
          default: 10000
          description: Maximum number of pages to crawl
        max_depth:
          type: integer
          default: 20
          description: Maximum crawl depth
        crawl_entire_domain:
          type: boolean
          default: true
          description: Whether to crawl the entire domain
        wait_for:
          type: integer
          default: 2000
          description: Time to wait for page to load in milliseconds
        include_screenshot:
          type: boolean
          default: true
          description: Include full page screenshot
        check_llms_txt:
          type: boolean
          default: true
          description: Check for llms.txt file for curated documentation URLs
        llms_txt_strategy:
          type: string
          enum: [prefer, only, ignore]
          default: prefer
          description: |
            How to use llms.txt if found:
            - prefer: Start with llms.txt URLs, then crawl additional pages if under limit
            - only: Only index URLs listed in llms.txt
            - ignore: Skip llms.txt check (traditional behavior)
        display_name:
          type: string
          description: Custom display name for the source
        is_pdf:
          type: boolean
          default: false
          description: Whether this is a direct PDF URL (disables crawling, uses longer timeout)
        focus_instructions:
          type: string
          maxLength: 500
          description: |
            Natural language instructions for what section to index.
            Finds the matching section root URL and indexes all pages under it.
            Example: "Only API reference" indexes /docs/api-reference/* instead of entire site.
        extract_branding:
          type: boolean
          default: false
          description: Extract brand identity and design system (colors, logos, fonts) from the page
        extract_images:
          type: boolean
          default: false
          description: Extract all image URLs from the page

    DataSourceResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the data source
        url:
          type: string
          description: The indexed URL
        file_name:
          type: string
          description: File name for text sources
        status:
          type: string
          enum: [pending, processing, completed, failed, error]
          description: Current indexing status
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        page_count:
          type: integer
          default: 0
          description: Number of pages indexed
        chunk_count:
          type: integer
          default: 0
          description: Number of chunks/embeddings created
        project_id:
          type: string
          description: Associated project ID if any
        source_type:
          type: string
          enum: [web, documentation, research_paper, text]
          default: web
        is_active:
          type: boolean
          default: true
        display_name:
          type: string
          description: Custom display name for the data source
        arxiv_id:
          type: string
          nullable: true
          description: arXiv identifier when source_type is research_paper
        paper_source:
          type: string
          nullable: true
          description: Research paper source provider (e.g. arxiv)
        metadata:
          type: object
          nullable: true
          additionalProperties: true
          description: |
            Optional lightweight metadata. For research_paper sources this may include title/authors/etc.
            For other source types this may be omitted.
        error:
          type: string
          description: Error message if status is 'error' or 'failed'
        error_code:
          type: string
          description: Error code for programmatic error handling
        category_id:
          type: string
          nullable: true
          description: Optional category ID for organizing data sources

    CategoryCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: Category name
          example: "ML Papers"
        color:
          type: string
          maxLength: 7
          description: Hex color code (e.g., #FF5733)
          example: "#4CAF50"
        order:
          type: integer
          minimum: 0
          description: Display order for sorting categories

    CategoryUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: Category name
        color:
          type: string
          maxLength: 7
          description: Hex color code (e.g., #FF5733)
        order:
          type: integer
          minimum: 0
          description: Display order for sorting categories

    CategoryResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the category
        name:
          type: string
          description: Category name
        user_id:
          type: string
          description: Owner user ID
        organization_id:
          type: string
          nullable: true
          description: Organization ID if category belongs to an organization
        color:
          type: string
          nullable: true
          description: Hex color code
        order:
          type: integer
          description: Display order
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategoriesListResponse:
      type: object
      properties:
        categories:
          type: array
          items:
            $ref: '#/components/schemas/CategoryResponse'
        total:
          type: integer
          description: Total number of categories

    CategoryAssignRequest:
      type: object
      properties:
        category_id:
          type: string
          nullable: true
          description: Category ID to assign, or null to remove category

    ResearchPaperRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: |
            arXiv URL or raw ID. Supports multiple formats:
            - Full URL: https://arxiv.org/abs/2312.00752
            - PDF URL: https://arxiv.org/pdf/2312.00752.pdf
            - Raw new-format ID: 2312.00752
            - Raw old-format ID: hep-th/9901001
            - With version: 2312.00752v1
          example: "2312.00752"

    ResearchPaperResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the data source
        arxiv_id:
          type: string
          description: The arXiv identifier (e.g., "2312.00752")
        title:
          type: string
          description: Paper title extracted from arXiv
        authors:
          type: array
          items:
            type: string
          description: List of paper authors
        abstract:
          type: string
          description: Paper abstract
        categories:
          type: array
          items:
            type: string
          description: arXiv categories (e.g., ["cs.CL", "cs.AI"])
        primary_category:
          type: string
          description: Primary arXiv category
        status:
          type: string
          enum: [pending, processing, completed, failed, error]
          description: Current indexing status (aligned with DataSourceResponse)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        chunk_count:
          type: integer
          default: 0
          description: Number of text chunks created from the paper
        doi:
          type: string
          nullable: true
          description: DOI if available
        published_date:
          type: string
          nullable: true
          description: Publication date from arXiv
        pdf_url:
          type: string
          description: Direct URL to the PDF
        abs_url:
          type: string
          description: URL to the arXiv abstract page
        error:
          type: string
          nullable: true
          description: Error message if status is 'failed'

    HuggingFaceDatasetRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: |
            HuggingFace dataset URL or identifier. Supports multiple formats:
            - Full URL: https://huggingface.co/datasets/squad
            - Owner/dataset: dair-ai/emotion
            - Dataset name: squad
          example: "dair-ai/emotion"
        config:
          type: string
          nullable: true
          description: Dataset configuration name (for multi-config datasets)
        add_as_global_source:
          type: boolean
          default: true
          description: Add to global shared pool (default true). Set false for private indexing.

    HuggingFaceDatasetResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the data source
        dataset_id:
          type: string
          description: Dataset identifier (e.g., "squad", "emotion")
        url:
          type: string
          description: Canonical HuggingFace dataset URL
        status:
          type: string
          enum: [pending, processing, completed, failed, error]
          description: Current indexing status
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        owner:
          type: string
          nullable: true
          description: Dataset owner/organization
        description:
          type: string
          nullable: true
          description: Dataset description
        splits:
          type: array
          items:
            type: string
          description: Available dataset splits (e.g., ["train", "test", "validation"])
        columns:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              dtype:
                type: string
          description: Dataset columns with names and data types
        row_count:
          type: integer
          default: 0
          description: Total number of rows in the dataset
        indexed_row_count:
          type: integer
          default: 0
          description: Number of rows actually indexed (may differ due to sampling)
        chunk_count:
          type: integer
          default: 0
          description: Number of text chunks created
        sampling_strategy:
          type: string
          nullable: true
          description: Sampling strategy used (full or sampled)
        license:
          type: string
          nullable: true
          description: Dataset license
        error:
          type: string
          nullable: true
          description: Error message if status is 'failed'

    HuggingFaceDatasetListItem:
      type: object
      properties:
        id:
          type: string
        dataset_id:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
        status:
          type: string
        source_type:
          type: string
          default: huggingface_dataset
        is_active:
          type: boolean
          default: true
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
        chunk_count:
          type: integer
          nullable: true
        display_name:
          type: string
          nullable: true
        owner:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        splits:
          type: array
          items:
            type: string
          nullable: true
        row_count:
          type: integer
          nullable: true
        indexed_row_count:
          type: integer
          nullable: true
        sampling_strategy:
          type: string
          nullable: true
        error:
          type: string
          nullable: true

    HuggingFaceDatasetListResponse:
      type: object
      properties:
        datasets:
          type: array
          items:
            $ref: '#/components/schemas/HuggingFaceDatasetListItem'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    GlobalSourceSubscribeRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: |
            URL of the source to subscribe to. Supports:
            - GitHub repository: https://github.com/owner/repo
            - Documentation: https://docs.example.com
            - arXiv paper: https://arxiv.org/abs/2312.00752 or 2312.00752
            - HuggingFace dataset: https://huggingface.co/datasets/squad or squad
          example: "https://github.com/vercel/ai-sdk"
        source_type:
          type: string
          enum: [repository, documentation, research_paper, huggingface_dataset]
          description: Source type. Auto-detected from URL if not provided.
        ref:
          type: string
          description: Git ref for repositories (branch, tag, or commit SHA).

    GlobalSourceSubscribeResponse:
      type: object
      properties:
        action:
          type: string
          enum: [instant_access, wait_for_indexing, not_indexed, use_private, indexing_started]
          description: |
            Action taken:
            - instant_access: Source is indexed and ready for immediate use
            - wait_for_indexing: Source is being indexed, you've been subscribed
            - not_indexed: Source is not indexed, use the index endpoint instead
            - use_private: You have a private index of this source
            - indexing_started: Indexing has been triggered (HuggingFace datasets)
        message:
          type: string
          description: Human-readable description of the action
        global_source_id:
          type: string
          nullable: true
          description: Canonical ID of the global source
        namespace:
          type: string
          nullable: true
          description: TurboPuffer namespace for the source
        status:
          type: string
          nullable: true
          description: Current status of the global source (indexed, indexing, pending, failed)
        local_reference_id:
          type: string
          nullable: true
          description: ID of the created local reference (project or data_source)
        display_name:
          type: string
          nullable: true
          description: Display name of the source

    GitHubTreeRequest:
      type: object
      required:
        - repository_id
      properties:
        repository_id:
          type: string
          description: Repository identifier (owner/repo format)
        branch:
          type: string
          description: Branch name (optional, defaults to repository's default branch)
        include_paths:
          type: array
          items:
            type: string
          description: Only show files in these paths (e.g., ["src/", "lib/"])
        exclude_paths:
          type: array
          items:
            type: string
          description: Hide files in these paths (e.g., ["node_modules/", "dist/"])
        file_extensions:
          type: array
          items:
            type: string
          description: Only show these file types (e.g., [".py", ".js", ".ts"])
        exclude_extensions:
          type: array
          items:
            type: string
          description: Hide these file types (e.g., [".md", ".lock", ".json"])
        show_full_paths:
          type: boolean
          default: false
          description: Show full paths instead of tree structure

    GitHubTreeResponse:
      type: object
      properties:
        repository:
          type: string
          description: Repository identifier
        branch:
          type: string
          description: Branch name
        tree:
          type: array
          items:
            type: object
            properties:
              path:
                type: string
              type:
                type: string
                enum: [file, tree]
              sha:
                type: string
        stats:
          type: object
          properties:
            total_files:
              type: integer
            total_directories:
              type: integer
        formatted_tree:
          type: string
          description: Text representation of the tree structure

    RegexSearchRequest:
      type: object
      required:
        - repositories
        - query
      properties:
        repositories:
          type: array
          items:
            type: string
          description: List of repositories to search (owner/repo format)
          example: ["facebook/react", "vercel/next.js"]
        query:
          type: string
          description: Natural language query or regex pattern
          example: "function handleSubmit"
        pattern:
          type: string
          description: Optional explicit regex pattern (overrides automatic extraction from query)
          example: "async\\s+function\\s+\\w+"
        file_extensions:
          type: array
          items:
            type: string
          description: File extensions to filter (e.g., [".js", ".tsx", ".py"])
        languages:
          type: array
          items:
            type: string
          description: Programming languages to filter (e.g., ["python", "javascript", "typescript"])
        max_results:
          type: integer
          default: 50
          minimum: 1
          maximum: 200
          description: Maximum number of results to return
        include_context:
          type: boolean
          default: true
          description: Include surrounding context lines
        context_lines:
          type: integer
          default: 3
          minimum: 0
          maximum: 10
          description: Number of context lines before/after match

    RegexSearchResponse:
      type: object
      properties:
        query:
          type: string
          description: The search query used
        pattern_used:
          type: string
          description: The regex pattern that was executed
        total_matches:
          type: integer
          description: Total number of matches found
        repositories_searched:
          type: array
          items:
            type: string
          description: Repositories that were searched
        results:
          type: array
          items:
            type: object
            properties:
              repository:
                type: string
              file_path:
                type: string
              line_number:
                type: integer
              matched_line:
                type: string
              context_before:
                type: array
                items:
                  type: string
              context_after:
                type: array
                items:
                  type: string
              language:
                type: string
        truncated:
          type: boolean
          description: Whether results were truncated due to max_results limit

    CodeGrepRequest:
      type: object
      required:
        - pattern
      properties:
        pattern:
          type: string
          description: Regex pattern to search for in repository code
          example: "async function\\s+\\w+"
        path:
          type: string
          default: ""
          description: Limit search to files with this path prefix
          example: "src/"
        ref:
          type: string
          description: Git ref to target (branch, tag, or commit). Useful when multiple versions are indexed.
        context_lines:
          type: integer
          minimum: 0
          maximum: 10
          description: Lines before AND after each match (shorthand for A/B). Overridden by A or B if specified.
        A:
          type: integer
          minimum: 0
          maximum: 20
          description: Lines after each match (like grep -A). Overrides context_lines for after.
        B:
          type: integer
          minimum: 0
          maximum: 20
          description: Lines before each match (like grep -B). Overrides context_lines for before.
        case_sensitive:
          type: boolean
          default: false
          description: Case-sensitive matching (default is case-insensitive)
        whole_word:
          type: boolean
          default: false
          description: Match whole words only
        fixed_string:
          type: boolean
          default: false
          description: Treat pattern as literal string, not regex
        max_matches_per_file:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
          description: Maximum matches to return per file
        max_total_matches:
          type: integer
          minimum: 1
          maximum: 1000
          default: 100
          description: Maximum total matches to return
        output_mode:
          type: string
          enum: [content, files_with_matches, count]
          default: content
          description: |
            Output format:
            - content: Return matched lines with context (grouped by file)
            - files_with_matches: Return only file paths that matched
            - count: Return match counts per file
        highlight:
          type: boolean
          default: false
          description: Add >>markers<< around matched text in results
        include_line_numbers:
          type: boolean
          default: true
          description: Include line numbers in results
        group_by_file:
          type: boolean
          default: true
          description: Group matches by file in results
        exhaustive:
          type: boolean
          default: true
          description: |
            Search ALL chunks for complete results (default: true).
            When true, iterates through all indexed chunks to find every match (like real grep).
            When false, uses BM25 keyword search to find top candidates first (faster but may miss matches).
            Automatically enabled when pattern has no extractable keywords.

    CodeGrepResponse:
      type: object
      properties:
        success:
          type: boolean
        matches:
          oneOf:
            - type: object
              additionalProperties:
                type: array
                items:
                  type: object
                  properties:
                    line_number:
                      type: integer
                    line:
                      type: string
                    context:
                      type: string
              description: Matches grouped by file path (when group_by_file is true)
            - type: array
              items:
                type: object
                properties:
                  path:
                    type: string
                  line_number:
                    type: integer
                  line:
                    type: string
                  context:
                    type: string
              description: Flat list of matches (when group_by_file is false)
        files:
          type: array
          items:
            type: string
          description: List of file paths (when output_mode is 'files_with_matches')
        counts:
          type: object
          additionalProperties:
            type: integer
          description: Match counts per file (when output_mode is 'count')
        pattern:
          type: string
          description: The regex pattern that was searched
        path_filter:
          type: string
          description: Path filter that was applied
        total_matches:
          type: integer
          description: Total number of matches found
        files_searched:
          type: integer
          description: Number of code chunks searched
        files_with_matches:
          type: integer
          description: Number of files that contained matches
        truncated:
          type: boolean
          description: Whether results were truncated due to limits
        options:
          type: object
          description: Applied search options
          properties:
            case_sensitive:
              type: boolean
            lines_before:
              type: integer
            lines_after:
              type: integer
            output_mode:
              type: string

    NiaReferences:
      type: object
      description: References to NIA resources used during the conversation
      properties:
        indexed_repositories:
          type: array
          items:
            type: string
          description: List of repository identifiers that were indexed
        indexed_documentation:
          type: array
          items:
            type: string
          description: List of documentation source identifiers
        queried_repositories:
          type: array
          items:
            type: string
          description: Repositories that were queried
        queried_documentation:
          type: array
          items:
            type: string
          description: Documentation sources that were queried
        web_searches:
          type: array
          items:
            type: string
          description: Web search queries performed
        deep_research_queries:
          type: array
          items:
            type: string
          description: Deep research queries performed

    EditedFile:
      type: object
      required:
        - file_path
      properties:
        file_path:
          type: string
          description: Path to the edited file
        operation:
          type: string
          enum: [created, modified, deleted]
          description: Type of operation performed on the file
        lines_added:
          type: integer
          description: Number of lines added (for created/modified operations)
        lines_removed:
          type: integer
          description: Number of lines removed (for modified/deleted operations)
        language:
          type: string
          description: Programming language of the file

    MemoryType:
      type: string
      enum: [scratchpad, episodic, fact, procedural]
      description: |
        Memory taxonomy type:
        - scratchpad: Temporary working memory (1hr TTL)
        - episodic: Session summaries (7d TTL)
        - fact: Atomic factual statements (permanent)
        - procedural: Tool/function definitions (permanent)

    LineageInput:
      type: object
      description: Provenance tracking input for content artifacts
      properties:
        source_ids:
          type: array
          items:
            type: string
          description: Source identifiers (e.g., 'repo:owner/repo', 'doc:name')
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence score 0-1
        derived_from:
          type: array
          items:
            type: string
          nullable: true
          description: Parent context IDs if derived
        tool_calls:
          type: array
          items:
            type: string
          nullable: true
          description: Tools used to create this artifact
        model_version:
          type: string
          nullable: true
          description: Model version that created this

    LineageMetadata:
      type: object
      description: Provenance tracking metadata for content artifacts
      properties:
        created_at:
          type: string
          format: date-time
          description: When this artifact was created
        source_ids:
          type: array
          items:
            type: string
          description: Source identifiers (e.g., 'repo:owner/repo', 'doc:name')
        confidence:
          type: number
          minimum: 0
          maximum: 1
          nullable: true
          description: Confidence score 0-1
        derived_from:
          type: array
          items:
            type: string
          nullable: true
          description: Parent context IDs if derived
        tool_calls:
          type: array
          items:
            type: string
          nullable: true
          description: Tools used to create this artifact
        model_version:
          type: string
          nullable: true
          description: Model version that created this

    TokenMetadata:
      type: object
      description: Token budget metadata for content responses
      properties:
        token_estimate:
          type: integer
          description: Estimated token count for returned content
        total_available_tokens:
          type: integer
          nullable: true
          description: Total tokens if reading full content
        tokens_used:
          type: integer
          nullable: true
          description: Tokens used in response (for searches)
        tokens_remaining:
          type: integer
          nullable: true
          description: Remaining tokens in budget
        results_truncated:
          type: boolean
          nullable: true
          description: Whether results were truncated due to budget
        total_results_available:
          type: integer
          nullable: true
          description: Total results available before truncation

    ContextShareRequest:
      type: object
      required:
        - title
        - summary
        - content
        - agent_source
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: Descriptive title for the context
        summary:
          type: string
          minLength: 10
          maxLength: 1000
          description: Brief summary of the conversation
        content:
          type: string
          minLength: 50
          description: Full conversation context
        agent_source:
          type: string
          description: Which agent is creating this context (e.g., "cursor", "claude-code")
        tags:
          type: array
          items:
            type: string
          description: Searchable tags for categorization
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata like file paths, repositories discussed, etc.
        nia_references:
          $ref: '#/components/schemas/NiaReferences'
        edited_files:
          type: array
          items:
            $ref: '#/components/schemas/EditedFile'
          description: List of files that were modified during conversation
        workspace_override:
          type: string
          description: Optional custom workspace name (overrides auto-detection)
        memory_type:
          $ref: '#/components/schemas/MemoryType'
        ttl_seconds:
          type: integer
          minimum: 0
          nullable: true
          description: Custom TTL in seconds. If not set, uses memory_type default (scratchpad=3600, episodic=604800, fact/procedural=permanent)
        lineage:
          $ref: '#/components/schemas/LineageInput'

    ContextShareResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the context
        user_id:
          type: string
          description: User who created the context
        organization_id:
          type: string
          description: Organization ID if context belongs to an organization
        title:
          type: string
          description: Context title
        summary:
          type: string
          description: Context summary
        content:
          type: string
          description: Full context content
        tags:
          type: array
          items:
            type: string
        agent_source:
          type: string
          description: Source agent (e.g., "cursor", "claude-code")
        created_at:
          type: string
          format: date-time
          description: When the context was created
        updated_at:
          type: string
          format: date-time
          description: When the context was last updated
        metadata:
          type: object
          additionalProperties: true
        nia_references:
          $ref: '#/components/schemas/NiaReferences'
        edited_files:
          type: array
          items:
            $ref: '#/components/schemas/EditedFile'
        memory_type:
          $ref: '#/components/schemas/MemoryType'
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When this context will expire (null for permanent memory types)
        lineage:
          $ref: '#/components/schemas/LineageMetadata'

    ContextShareUpdateRequest:
      type: object
      description: Request to update an existing context (all fields optional)
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          minLength: 10
          maxLength: 1000
        content:
          type: string
          minLength: 50
        tags:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties: true
        nia_references:
          $ref: '#/components/schemas/NiaReferences'
        edited_files:
          type: array
          items:
            $ref: '#/components/schemas/EditedFile'
        memory_type:
          $ref: '#/components/schemas/MemoryType'
        ttl_seconds:
          type: integer
          minimum: 0
          nullable: true
          description: Custom TTL in seconds
        lineage:
          $ref: '#/components/schemas/LineageInput'

    OracleResearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Research question to investigate
          example: "How does authentication work in the FastAPI codebase?"
        repositories:
          type: array
          items:
            type: string
          description: Optional list of repository identifiers to search
          example: ["fastapi/fastapi", "tiangolo/sqlmodel"]
        data_sources:
          type: array
          items:
            type: string
          description: Optional list of documentation source identifiers to search
          example: ["FastAPI Documentation", "SQLModel Docs"]
        output_format:
          type: string
          description: Optional output format specification
          example: "markdown report with code examples"
        model:
          type: string
          description: Optional model selection for Oracle (defaults to claude-opus-4-6)
          enum:
            - claude-opus-4-6
            - claude-opus-4-6-1m
            - claude-sonnet-4-5-20250929
            - claude-sonnet-4-5-1m

    OracleCitation:
      type: object
      description: A single grounded "citation" entry recorded by Oracle during tool use.
      properties:
        source_id:
          type: integer
          description: Monotonic integer id (1-based) assigned during the run
        tool:
          type: string
          description: Tool/action name that produced this citation
        args:
          type: object
          additionalProperties: true
          description: Tool arguments used
        summary:
          type: string
          description: Short summary of the tool result (truncated)

    OracleToolCall:
      type: object
      description: A single tool call logged by Oracle during the run.
      properties:
        action:
          type: string
          description: Tool/action name
        args:
          type: object
          additionalProperties: true
          description: Tool arguments used
        timestamp:
          type: string
          format: date-time
          description: ISO timestamp when the tool was executed

    OracleResearchResponse:
      type: object
      properties:
        query:
          type: string
          description: The research query that was executed
        final_report:
          type: string
          description: The comprehensive research report generated by Oracle
        citations:
          type: array
          items:
            $ref: '#/components/schemas/OracleCitation'
          description: Tool-result citations recorded during the run
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/OracleToolCall'
          description: List of tool calls made during research
        iterations:
          type: integer
          description: Number of research iterations performed
        duration_ms:
          type: integer
          description: Duration of the research in milliseconds
        session_id:
          type: string
          description: Unique session identifier for this research
        created_at:
          type: string
          format: date-time
          description: When this research session was created

    OracleSessionSummary:
      type: object
      description: Summary of a persisted Oracle research session.
      properties:
        session_id:
          type: string
        title:
          type: string
          nullable: true
        query:
          type: string
        created_at:
          type: string
          format: date-time
        iterations:
          type: integer
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        status:
          type: string
        model:
          type: string
          nullable: true

    OracleSessionDetails:
      allOf:
        - $ref: '#/components/schemas/OracleSessionSummary'
        - type: object
          properties:
            final_report:
              type: string
            citations:
              type: array
              items:
                $ref: '#/components/schemas/OracleCitation'
            tool_calls:
              type: array
              items:
                $ref: '#/components/schemas/OracleToolCall'
            research_notes:
              type: array
              items:
                type: string
            prioritized_repositories:
              type: array
              items:
                type: string
            prioritized_data_sources:
              type: array
              items:
                type: string
            discovered_repositories:
              type: array
              items:
                type: string
            discovered_data_sources:
              type: array
              items:
                type: string
            output_format:
              type: string
              nullable: true
            metadata:
              type: object
              additionalProperties: true

    OracleSessionChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 10000
          description: User's follow-up question

    OracleChatMessage:
      type: object
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        created_at:
          type: string
          format: date-time
          nullable: true
        is_original:
          type: boolean
        message_id:
          type: string
          nullable: true
        citations:
          type: array
          items:
            $ref: '#/components/schemas/OracleCitation'
          nullable: true

    OracleSessionMessagesResponse:
      type: object
      properties:
        session_id:
          type: string
        messages:
          type: array
          items:
            $ref: '#/components/schemas/OracleChatMessage'
        total:
          type: integer

    # Dependency Analysis Schemas
    DependencyAnalyzeRequest:
      type: object
      required:
        - manifest_content
      properties:
        manifest_content:
          type: string
          description: Raw content of the manifest file
        manifest_type:
          type: string
          enum: [package.json, requirements.txt, pyproject.toml, Cargo.toml, go.mod, Gemfile]
          description: Manifest type. Auto-detected if not provided.
        filename:
          type: string
          description: Original filename for type detection

    DependencySubscribeRequest:
      type: object
      required:
        - manifest_content
      properties:
        manifest_content:
          type: string
          description: Raw content of the manifest file
        manifest_type:
          type: string
          enum: [package.json, requirements.txt, pyproject.toml, Cargo.toml, go.mod, Gemfile]
          description: Manifest type. Auto-detected if not provided.
        filename:
          type: string
          description: Original filename for type detection
        include_dev_dependencies:
          type: boolean
          default: false
          description: Include devDependencies/dev-dependencies
        max_new_indexes:
          type: integer
          minimum: 0
          maximum: 500
          default: 150
          description: Max number of new indexes to start (0-500)

    DependencyItem:
      type: object
      properties:
        name:
          type: string
        version:
          type: string
          nullable: true
        registry:
          type: string
        is_dev:
          type: boolean

    MappingItem:
      type: object
      properties:
        name:
          type: string
        registry:
          type: string
        docs_url:
          type: string
          nullable: true
        mapping_source:
          type: string
        confidence:
          type: number

    AnalyzeResponse:
      type: object
      properties:
        manifest_type:
          type: string
        total_dependencies:
          type: integer
        dependencies:
          type: array
          items:
            $ref: '#/components/schemas/DependencyItem'
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/MappingItem'
        unmapped_count:
          type: integer
        unmapped_packages:
          type: array
          items:
            type: string

    SubscriptionResultItem:
      type: object
      properties:
        name:
          type: string
        action:
          type: string
        docs_url:
          type: string
          nullable: true
        global_source_id:
          type: string
          nullable: true
        namespace:
          type: string
          nullable: true
        message:
          type: string

    SubscriptionResults:
      type: object
      properties:
        instant_access:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'
        wait_for_indexing:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'
        started_indexing:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'
        not_found:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'
        errors:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'
        skipped:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionResultItem'

    SubscriptionSummary:
      type: object
      properties:
        instant_access:
          type: integer
        wait_for_indexing:
          type: integer
        started_indexing:
          type: integer
        not_found:
          type: integer
        errors:
          type: integer
        skipped:
          type: integer

    SubscribeResponse:
      type: object
      properties:
        manifest_type:
          type: string
        total_dependencies:
          type: integer
        results:
          $ref: '#/components/schemas/SubscriptionResults'
        summary:
          $ref: '#/components/schemas/SubscriptionSummary'

    # Advisor Schemas
    CodebaseContext:
      type: object
      properties:
        files:
          type: object
          additionalProperties:
            type: string
          description: Map of file_path to file_content
        file_tree:
          type: string
          nullable: true
          description: Directory structure (from tree command or similar)
        dependencies:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Dependency files content (package.json, requirements.txt, etc.)
        git_diff:
          type: string
          nullable: true
          description: Git diff output for recent changes
        summary:
          type: string
          nullable: true
          description: Brief summary of the codebase/project
        focus_paths:
          type: array
          items:
            type: string
          nullable: true
          description: Specific paths the user is working on

    AdvisorSearchScope:
      type: object
      properties:
        repositories:
          type: array
          items:
            type: string
          nullable: true
          description: Repository identifiers to search
        data_sources:
          type: array
          items:
            type: string
          nullable: true
          description: Documentation source IDs to search

    AdvisorRequest:
      type: object
      required:
        - query
        - codebase
      properties:
        query:
          type: string
          description: User's question
        codebase:
          $ref: '#/components/schemas/CodebaseContext'
        search_scope:
          $ref: '#/components/schemas/AdvisorSearchScope'
        output_format:
          type: string
          enum: [explanation, checklist, diff, structured]
          default: explanation
          description: Output format

    AdvisorResponse:
      type: object
      properties:
        advice:
          type: string
          description: Tailored advice based on codebase and documentation
        sources_searched:
          type: integer
          description: Number of sources searched
        output_format:
          type: string
          description: Output format used

    # =========================================================================
    # Local Folder Schemas
    # =========================================================================

    FileItem:
      type: object
      required:
        - path
        - content
      properties:
        path:
          type: string
          description: Relative file path (e.g., 'src/main.py', 'notes/meeting.md')
          example: "notes/meeting.md"
        content:
          type: string
          description: File content as UTF-8 string

    CreateLocalFolderRequest:
      type: object
      required:
        - files
      properties:
        folder_name:
          type: string
          description: Display name for the folder
          example: "My Notes"
        folder_path:
          type: string
          description: Original folder path on user's machine (metadata only, not used for reading)
          example: "/Users/me/Documents/notes"
        files:
          type: array
          items:
            $ref: '#/components/schemas/FileItem'
          description: List of files with path and content to index
          minItems: 1

    ClassificationInfo:
      type: object
      properties:
        categories:
          type: array
          items:
            type: string
          description: List of detected categories
        distribution:
          type: object
          additionalProperties:
            type: integer
          description: Category distribution counts
        total_classified:
          type: integer
          description: Total items classified
        status:
          type: string
          enum: [pending, processing, completed, failed]
          description: Classification status
        progress:
          type: integer
          nullable: true
          description: Classification progress (0-100)
        classified_at:
          type: string
          nullable: true
          description: When classification completed (ISO timestamp)

    ContinuousSyncInfo:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether continuous sync is enabled
        last_sync:
          type: string
          nullable: true
          description: Last sync timestamp
        sync_cursor:
          type: object
          nullable: true
          description: Cursor for incremental sync

    LocalFolderItem:
      type: object
      required:
        - id
        - display_name
        - status
      properties:
        id:
          type: string
          format: uuid
          description: Local folder UUID
        display_name:
          type: string
          description: Display name
        folder_path:
          type: string
          nullable: true
          description: Original folder path (metadata)
        status:
          type: string
          enum: [processing, completed, indexed, failed]
          description: Indexing status
        file_count:
          type: integer
          default: 0
          description: Number of files indexed
        chunk_count:
          type: integer
          default: 0
          description: Number of chunks created
        created_at:
          type: string
          nullable: true
          description: Creation timestamp (ISO)
        updated_at:
          type: string
          nullable: true
          description: Last update timestamp (ISO)
        error:
          type: string
          nullable: true
          description: Error message if status is 'failed'
        classification:
          $ref: '#/components/schemas/ClassificationInfo'
        source_subtype:
          type: string
          nullable: true
          enum: [database, folder]
          description: Source subtype
        db_type:
          type: string
          nullable: true
          description: Database type (imessage, whatsapp, generic)
        continuous_sync:
          $ref: '#/components/schemas/ContinuousSyncInfo'
        category_id:
          type: string
          nullable: true
          description: Category ID if assigned

    LocalFolderListResponse:
      type: object
      properties:
        local_folders:
          type: array
          items:
            $ref: '#/components/schemas/LocalFolderItem'
        total:
          type: integer
          description: Total number of local folders

    RenameLocalFolderRequest:
      type: object
      required:
        - new_name
      properties:
        new_name:
          type: string
          minLength: 1
          maxLength: 200
          description: New display name

    LocalFolderTreeResponse:
      type: object
      properties:
        tree:
          type: object
          description: File tree structure
        total_files:
          type: integer
          description: Total number of files

    LocalFolderReadRequest:
      type: object
      properties:
        path:
          type: string
          description: File path to read
        line_start:
          type: integer
          description: Start line (1-indexed)
        line_end:
          type: integer
          description: End line (1-indexed)

    LocalFolderReadResponse:
      type: object
      properties:
        content:
          type: string
          description: File content
        path:
          type: string
          description: File path
        total_lines:
          type: integer
          description: Total lines in file

    LocalFolderGrepRequest:
      type: object
      required:
        - pattern
      properties:
        pattern:
          type: string
          description: Regex pattern to search
        path:
          type: string
          description: Path prefix filter
        case_sensitive:
          type: boolean
          default: false
        context_lines:
          type: integer
          default: 2
          description: Lines of context around matches
        max_matches:
          type: integer
          default: 100
          description: Maximum matches to return

    LocalFolderGrepResponse:
      type: object
      properties:
        matches:
          type: array
          items:
            type: object
            properties:
              file_path:
                type: string
              line_number:
                type: integer
              content:
                type: string
              context_before:
                type: array
                items:
                  type: string
              context_after:
                type: array
                items:
                  type: string
        total_matches:
          type: integer

    DatabaseUploadRequest:
      type: object
      required:
        - database
      properties:
        database:
          type: object
          required:
            - filename
            - content
          properties:
            filename:
              type: string
              description: Database filename
            content:
              type: string
              format: byte
              description: Base64-encoded database content

    CreateDatabaseFolderRequest:
      type: object
      required:
        - folder_name
        - db_type
        - database
      properties:
        folder_name:
          type: string
          description: Display name for the folder
        db_type:
          type: string
          enum: [imessage, whatsapp, generic]
          description: Database type
        database:
          type: object
          required:
            - filename
            - content
          properties:
            filename:
              type: string
            content:
              type: string
              format: byte
              description: Base64-encoded SQLite database

    SyncResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        new_items:
          type: integer
          description: Number of new items synced
        updated_items:
          type: integer
          description: Number of items updated

    ContinuousSyncUpdateRequest:
      type: object
      properties:
        enabled:
          type: boolean
          description: Enable or disable continuous sync

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message

  responses:
    UnauthorizedError:
      description: API key is missing or invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    RateLimitError:
      description: Rate limit has been exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Rate limit ceiling for the endpoint
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Number of requests remaining in the time window
        X-RateLimit-Reset:
          schema:
            type: string
            format: date-time
          description: Time when the rate limit resets
        X-Monthly-Limit:
          schema:
            type: integer
          description: Monthly request limit
        X-Monthly-Remaining:
          schema:
            type: integer
          description: Remaining requests for the month
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

paths:
  /sources:
    get:
      tags: [Sources]
      summary: List sources
      description: List all sources with consistent pagination and filters.
      parameters:
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
        - name: query
          in: query
          required: false
          schema:
            type: string
        - name: status
          in: query
          required: false
          schema:
            type: string
        - name: category_id
          in: query
          required: false
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceListResponse'
    post:
      tags: [Sources]
      summary: Create source
      description: Create and index a new source.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SourceCreateRequest'
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Source'

  /sources/resolve:
    get:
      tags: [Sources]
      summary: Resolve source identifier
      description: Resolve a name or URL to a source ID.
      parameters:
        - name: identifier
          in: query
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceResolveResponse'

  /sources/{source_id}:
    get:
      tags: [Sources]
      summary: Get source
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Source'
    patch:
      tags: [Sources]
      summary: Update source
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SourceUpdateRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Source'
    delete:
      tags: [Sources]
      summary: Delete source
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceDeleteResponse'

  /sources/{source_id}/tree:
    get:
      tags: [Sources]
      summary: Get source tree
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /sources/{source_id}/content:
    get:
      tags: [Sources]
      summary: Get source content
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
        - name: path
          in: query
          required: false
          schema:
            type: string
        - name: url
          in: query
          required: false
          schema:
            type: string
        - name: branch
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /sources/{source_id}/grep:
    post:
      tags: [Sources]
      summary: Grep within a source
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /sources/{source_id}/sync:
    post:
      tags: [Sources]
      summary: Sync source
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /sources/{source_id}/classification:
    get:
      tags: [Sources]
      summary: Get source classification
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
    patch:
      tags: [Sources]
      summary: Update source classification
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourceType'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /search:
    post:
      tags: [Search]
      summary: Unified search
      description: Single search endpoint with mode discriminator.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
  /repositories:
    get:
      summary: List all repositories
      description: List all indexed repositories for the authenticated user
      operationId: listRepositories
      tags:
        - Repositories
      parameters:
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Optional substring filter (matches repository/display_name)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Optional status filter (e.g. completed|indexing|failed)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 5000
          description: "Max repositories to return (default: all)"
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of repositories to skip
      responses:
        '200':
          description: List of repositories retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RepositoryListItem'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
    post:
      summary: Index a new repository
      description: |
        Start indexing a GitHub repository. The repository must be public or the request must include
        a GitHub token with appropriate access rights. Supports indexing specific folders within a repository
        by providing a path like "owner/repo/tree/branch/folder".
      operationId: indexRepository
      tags:
        - Repositories
      parameters:
        - name: X-GitHub-Token
          in: header
          required: false
          schema:
            type: string
          description: Optional GitHub token for private repository access
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RepositoryRequest'
      responses:
        '200':
          description: Repository indexing started successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      repository_id:
                        type: string
                      status:
                        type: string
                      status_url:
                        type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /repositories/{repository_id}:
    get:
      summary: Get repository indexing status
      description: Check the current status of repository indexing
      operationId: getRepositoryStatus
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the repository returned from the index endpoint
      responses:
        '200':
          description: Repository status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RepositoryStatus'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
    delete:
      summary: Delete a repository
      description: Remove an indexed repository from your account
      operationId: deleteRepository
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the repository to delete
      responses:
        '200':
          description: Repository deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /repositories/{repository_id}/rename:
    patch:
      summary: Rename a repository
      description: Update the display name of an indexed repository
      operationId: renameRepository
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the repository to rename
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenameRequest'
      responses:
        '200':
          description: Repository renamed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  repository_id:
                    type: string
                  display_name:
                    type: string
                  message:
                    type: string
        '400':
          description: Invalid request (e.g., empty name)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /repositories/{repository_id}/tree:
    get:
      summary: Get repository tree structure
      description: |
        Get the file and folder structure directly from GitHub API (no indexing required).
        This endpoint provides a fast way to explore repository structure with flexible filtering
        options for paths and file extensions.
      operationId: getRepositoryTree
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: Repository identifier in owner/repo format
        - name: branch
          in: query
          required: false
          schema:
            type: string
          description: Branch name (defaults to repository's default branch)
        - name: include_paths
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          description: Only show files in these paths (e.g., "src/,lib/")
          style: form
          explode: false
        - name: exclude_paths
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          description: Hide files in these paths (e.g., "node_modules/,dist/")
          style: form
          explode: false
        - name: file_extensions
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          description: Only show these file types (e.g., ".py,.js,.ts")
          style: form
          explode: false
        - name: exclude_extensions
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          description: Hide these file types (e.g., ".md,.lock,.json")
          style: form
          explode: false
        - name: show_full_paths
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Show full paths instead of tree structure
      responses:
        '200':
          description: Repository tree retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubTreeResponse'
        '400':
          description: Invalid repository identifier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /repositories/{repository_id}/content:
    get:
      summary: Get repository file content
      description: |
        Retrieve the full content of a file from an indexed repository.
        Provide the file path within the repository to get its contents.
      operationId: getRepositoryContent
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: Repository identifier in owner/repo format
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Path to the file within the repository
          example: "src/main.py"
        - name: branch
          in: query
          required: false
          schema:
            type: string
          description: Branch to read from (optional)
        - name: ref
          in: query
          required: false
          schema:
            type: string
          description: Git ref to read from (branch, tag, or commit)
      responses:
        '200':
          description: File content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  content:
                    type: string
                    description: Full file content
                  metadata:
                    type: object
                    properties:
                      file_path:
                        type: string
                      language:
                        type: string
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Repository or file not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /repositories/{repository_id}/grep:
    post:
      summary: Search repository code with regex
      description: |
        Search repository code with a regex pattern.
        Like the Unix 'grep' command, but for indexed repository code.
        Searches through all code chunks and returns matches with context.
        
        By default (exhaustive=true), iterates through ALL indexed chunks to find every match,
        providing true grep-like behavior. For faster but potentially incomplete results,
        set exhaustive=false to use BM25 keyword search first.
        
        Supports asymmetric context lines (A for after, B for before), case sensitivity,
        whole word matching, and multiple output modes.
      operationId: grepRepository
      tags:
        - Repositories
      parameters:
        - name: repository_id
          in: path
          required: true
          schema:
            type: string
          description: Repository identifier in owner/repo format
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CodeGrepRequest'
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CodeGrepResponse'
        '400':
          description: Invalid regex pattern or request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found or not indexed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Search execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /search/query:
    post:
      summary: Query indexed sources
      description: |
        Send a query to get AI-powered insights about indexed sources.

        **Queryable source types:**
        - **repositories**: GitHub repositories (pass via `repositories` param)
        - **data_sources**: Documentation, research papers, AND HuggingFace datasets (pass via `data_sources` param)

        **Search modes:**
        - `repositories`: Search only code repositories (default)
        - `sources`: Search only data sources (docs, papers, datasets) - returns vector search results without LLM processing

        Supports both streaming and non-streaming responses.
      operationId: searchQuery
      tags:
        - Search & Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Query processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                  sources:
                    type: array
                    items:
                      oneOf:
                        - type: string
                        - type: object
                          properties:
                            file_path:
                              type: string
                            content:
                              type: string
                    description: Code snippets used to generate the response (included when include_sources=true)
                  source_paths:
                    type: array
                    items:
                      type: string
                    description: File paths of the code snippets (included when include_sources=false)
            text/event-stream:
              schema:
                type: string
                description: |
                  Stream of Server-Sent Events (SSE) with the following event types:
                  - sources: List of relevant code sources (when include_sources=true)
                  - source_paths: List of file paths without content (when include_sources=false)
                  - content: Chunks of the AI response
                  - error: Any errors that occur during streaming
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /search/web:
    post:
      summary: Web search
      description: |
        Perform a web search to find relevant content.
        Supports filtering by category and time range, as well as finding similar content to a given URL.
      operationId: searchWeb
      tags:
        - Search & Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebSearchRequest'
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebSearchResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '503':
          description: Web search service temporarily unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /search/deep:
    post:
      summary: Deep research agent (Pro only)
      description: |
        Perform deep, multi-step research on a topic using advanced AI research capabilities.
        This endpoint is only available for Pro subscription users. The research agent will
        analyze multiple sources, synthesize information, and provide comprehensive answers
        with citations.
      operationId: searchDeep
      tags:
        - Search & Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeepResearchRequest'
      responses:
        '200':
          description: Research completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeepResearchResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pro subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '503':
          description: Research service temporarily unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '504':
          description: Research task timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /search/universal:
    post:
      summary: Universal search across all public sources
      description: |
        Search across ALL indexed public sources in a single query.

        **Searches across:**
        - GitHub repositories
        - Documentation/websites
        - Research papers (arXiv)
        - HuggingFace datasets (when `include_huggingface_datasets=true`)

        This endpoint performs a two-phase hybrid search:
        1. **Discovery Phase**: Fast O(1) search across a universal index to identify relevant sources
        2. **Deep Search Phase**: Targeted searches into the top matching source namespaces for comprehensive results

        Results are combined using Reciprocal Rank Fusion (RRF) for optimal ranking.

        Use this when you want to discover relevant content without knowing which specific sources to search.

        **Performance**: Typically returns results in 1-3 seconds for thousands of indexed sources.
      operationId: searchUniversal
      tags:
        - Search & Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UniversalSearchRequest'
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UniversalSearchResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Search execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /data-sources:
    get:
      summary: List all data sources
      description: |
        List all indexed data sources for the authenticated user.

        **Supported source types:**
        - `documentation` / `web` - Indexed websites and documentation
        - `research_paper` - arXiv papers
        - `huggingface_dataset` - HuggingFace datasets

        Use the `source_type` query parameter to filter by type.
      operationId: listDataSources
      tags:
        - Data Sources
      parameters:
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Optional substring filter (matches display_name/url/file_name)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Optional status filter (e.g. completed|indexing|failed)
        - name: source_type
          in: query
          required: false
          schema:
            type: string
          description: Optional source type filter (e.g. web|documentation|research_paper|text)
        - name: category_id
          in: query
          required: false
          schema:
            type: string
          description: Optional category filter. Use 'uncategorized' for sources without category
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
          description: Max data sources to return (db-level pagination)
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of data sources to skip (db-level pagination)
      responses:
        '200':
          description: List of data sources retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataSourceResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
    post:
      summary: Index a new data source
      description: |
        Start indexing a documentation website or any web content.
        Supports advanced crawling options like URL patterns, content filtering, and llms.txt support.
      operationId: createDataSource
      tags:
        - Data Sources
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DataSourceRequest'
      responses:
        '200':
          description: Data source indexing started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSourceResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}:
    get:
      summary: Get data source details
      description: |
        Get detailed information about a specific data source.

        **Works with all source types:** documentation, research papers, and HuggingFace datasets.
      operationId: getDataSource
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core", "openai/gsm8k")
            - URL (e.g., "https://docs.trynia.ai/", "https://arxiv.org/abs/2312.00752")
      responses:
        '200':
          description: Data source details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSourceResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
    delete:
      summary: Delete a data source
      description: Remove an indexed data source from your account
      operationId: deleteDataSource
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core")
            - URL (e.g., "https://docs.trynia.ai/")
      responses:
        '200':
          description: Data source deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/content:
    get:
      summary: Get data source page content
      description: |
        Retrieve the full content of a page from an indexed documentation source.
        Provide either a virtual path or direct URL to get the page contents.
      operationId: getDataSourceContent
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core")
            - URL (e.g., "https://docs.trynia.ai/")
        - name: path
          in: query
          required: false
          schema:
            type: string
          description: Virtual path to the page within the documentation
          example: "/getting-started/installation"
        - name: url
          in: query
          required: false
          schema:
            type: string
          description: Direct URL of the page (alternative to path)
      responses:
        '200':
          description: Page content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  content:
                    type: string
                    description: Full page content in markdown format
                  url:
                    type: string
                    description: Original URL of the page
                  metadata:
                    type: object
                    properties:
                      title:
                        type: string
                      total_lines:
                        type: integer
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Data source or page not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/tree:
    get:
      summary: Get data source tree structure
      description: |
        Get the tree structure of an indexed data source.

        **Works with all source types:**

        - **Documentation:** Returns a filesystem-like tree structure of indexed pages,
          making it easy to browse documentation without remembering URLs.

        - **Research Papers:** Returns the document structure with sections and subsections.

        - **HuggingFace Datasets:** Returns a tree showing dataset splits and columns,
          with metadata about row counts and sampling strategy.
      operationId: getDocumentationTree
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core")
            - URL (e.g., "https://docs.trynia.ai/")
      responses:
        '200':
          description: Tree structure retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tree:
                    oneOf:
                      - type: object
                        description: Nested tree structure of documentation pages
                      - type: array
                        description: Tree structure for HuggingFace datasets (splits with columns)
                        items:
                          type: object
                          properties:
                            name:
                              type: string
                              description: Split name (e.g., "train", "test", "validation")
                            type:
                              type: string
                              enum: [split]
                            children:
                              type: array
                              items:
                                type: object
                                properties:
                                  name:
                                    type: string
                                    description: Column name
                                  type:
                                    type: string
                                    enum: [column]
                  tree_string:
                    type: string
                    description: Formatted text representation of the tree
                  tree_type:
                    type: string
                    enum: [documentation, huggingface_dataset]
                    description: Type of tree structure returned
                  base_url:
                    type: string
                    description: Base URL of the documentation (documentation sources only)
                  page_count:
                    type: integer
                    description: Total number of indexed pages (documentation sources only)
                  dataset_id:
                    type: string
                    description: Dataset identifier (HuggingFace datasets only)
                  owner:
                    type: string
                    nullable: true
                    description: Dataset owner/organization (HuggingFace datasets only)
                  description:
                    type: string
                    nullable: true
                    description: Dataset description (HuggingFace datasets only)
                  splits:
                    type: array
                    items:
                      type: string
                    description: Available dataset splits (HuggingFace datasets only)
                  columns:
                    type: array
                    items:
                      type: string
                    description: Dataset column names (HuggingFace datasets only)
                  row_count:
                    type: integer
                    description: Total number of rows in dataset (HuggingFace datasets only)
                  indexed_row_count:
                    type: integer
                    description: Number of rows actually indexed (HuggingFace datasets only)
                  sampling_strategy:
                    type: string
                    nullable: true
                    description: Sampling strategy used (full or sampled) (HuggingFace datasets only)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/ls:
    get:
      summary: List data source directory contents
      description: |
        List contents of a virtual directory in the data source.
        Shows files (pages) and subdirectories at the specified path,
        similar to the Unix 'ls' command.

        **Works with all source types:** documentation, research papers, and HuggingFace datasets.
      operationId: listDocumentationDirectory
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: Flexible data source identifier (UUID, display name, or URL)
        - name: path
          in: query
          required: false
          schema:
            type: string
            default: "/"
          description: Virtual path to list (default is root "/")
      responses:
        '200':
          description: Directory contents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  path:
                    type: string
                    description: The path that was listed
                  directories:
                    type: array
                    items:
                      type: string
                    description: Subdirectories at this path
                  files:
                    type: array
                    items:
                      type: string
                    description: Files (pages) at this path
                  total:
                    type: integer
                    description: Total number of items
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/read:
    get:
      summary: Read data source content
      description: |
        Read content from a data source by its virtual filesystem path.

        **Works with all source types:**

        - **Documentation:** Read page content by virtual path (e.g., "/api/authentication.md")
        - **Research Papers:** Read paper sections by path
        - **HuggingFace Datasets:** Read dataset rows (returns formatted row content)

        Supports line range slicing and length truncation for efficient content retrieval.
      operationId: readDocumentationPage
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: Flexible data source identifier (UUID, display name, or URL)
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Virtual path to the page (e.g., "/api/authentication.md")
        - name: line_start
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Start line number (1-based, inclusive). Use with line_end for slicing.
        - name: line_end
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: End line number (1-based, inclusive). Use with line_start for slicing.
        - name: max_length
          in: query
          required: false
          schema:
            type: integer
            minimum: 100
            maximum: 100000
          description: Maximum number of characters to return (100-100000). Content will be truncated if exceeded.
      responses:
        '200':
          description: Page content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  path:
                    type: string
                    description: The virtual path requested
                  url:
                    type: string
                    description: The actual URL of the page
                  content:
                    type: string
                    description: Full or partial content of the documentation page
                  total_lines:
                    type: integer
                    description: Total number of lines in the document
                  returned_lines:
                    type: array
                    items:
                      type: integer
                    minItems: 2
                    maxItems: 2
                    description: "[start_line, end_line] range of returned content"
                  truncated:
                    type: boolean
                    description: Whether content was truncated due to max_length limit
                  # HuggingFace dataset specific fields
                  split:
                    type: string
                    description: Dataset split name (HuggingFace datasets only)
                  row_index:
                    type: integer
                    description: Row index in the dataset (HuggingFace datasets only)
                  chunks_returned:
                    type: integer
                    description: Number of chunks returned (HuggingFace datasets only)
                  source_type:
                    type: string
                    enum: [documentation, huggingface_dataset, research_paper]
                    description: Type of the data source
                  metadata:
                    type: object
                    properties:
                      url:
                        type: string
                      source_id:
                        type: string
                      chunks_found:
                        type: integer
                      title:
                        type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source or path not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/grep:
    post:
      summary: Search data source with regex
      description: |
        Search data source content with a regex pattern.
        Like the Unix 'grep' command, but for indexed content.

        **Works with all source types:**

        - **Documentation:** Searches through all pages and returns matches with context
        - **Research Papers:** Searches paper content for patterns
        - **HuggingFace Datasets:** Searches dataset rows and returns matches with split/row info

        By default (exhaustive=true), iterates through ALL indexed chunks to find every match,
        providing true grep-like behavior. For faster but potentially incomplete results,
        set exhaustive=false to use BM25 keyword search first.

        Supports asymmetric context lines (A for after, B for before),
        case sensitivity, whole word matching, and multiple output modes.
      operationId: grepDocumentation
      tags:
        - Data Sources
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: Flexible data source identifier (UUID, display name, or URL)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pattern
              properties:
                pattern:
                  type: string
                  description: Regex pattern to search for
                  example: "authentication.*token"
                path:
                  type: string
                  default: "/"
                  description: Limit search to this virtual path prefix
                context_lines:
                  type: integer
                  minimum: 0
                  maximum: 10
                  description: Lines before AND after each match (shorthand for A/B). Overridden by A or B if specified.
                A:
                  type: integer
                  minimum: 0
                  maximum: 20
                  description: Lines after each match (like grep -A). Overrides context_lines for after.
                B:
                  type: integer
                  minimum: 0
                  maximum: 20
                  description: Lines before each match (like grep -B). Overrides context_lines for before.
                case_sensitive:
                  type: boolean
                  default: false
                  description: Case-sensitive matching (default is case-insensitive)
                whole_word:
                  type: boolean
                  default: false
                  description: Match whole words only
                fixed_string:
                  type: boolean
                  default: false
                  description: Treat pattern as literal string, not regex
                max_matches_per_file:
                  type: integer
                  minimum: 1
                  maximum: 100
                  default: 10
                  description: Maximum matches to return per file
                max_total_matches:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  default: 100
                  description: Maximum total matches to return
                output_mode:
                  type: string
                  enum: [content, files_with_matches, count]
                  default: content
                  description: |
                    Output format:
                    - content: Return matched lines with context
                    - files_with_matches: Return only file paths that matched
                    - count: Return match counts per file
                highlight:
                  type: boolean
                  default: false
                  description: Add >>markers<< around matched text in results
                include_line_numbers:
                  type: boolean
                  default: true
                  description: Include line numbers in results
                group_by_file:
                  type: boolean
                  default: true
                  description: Group matches by file in results
                exhaustive:
                  type: boolean
                  default: true
                  description: |
                    Search ALL chunks for complete results (default: true).
                    When true, iterates through all indexed chunks to find every match (like real grep).
                    When false, uses BM25 keyword search to find top candidates first (faster but may miss matches).
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  source_type:
                    type: string
                    enum: [documentation, huggingface_dataset, research_paper]
                    description: Type of data source searched
                  matches:
                    type: array
                    description: |
                      Matches (format depends on source_type):
                      - For documentation: grouped by file with nested matches
                      - For HuggingFace datasets: flat list with split/row_index
                    items:
                      oneOf:
                        - type: object
                          title: HuggingFaceGrepMatch
                          description: Flat match for HuggingFace datasets
                          properties:
                            path:
                              type: string
                              description: Path in format "split/row_N"
                            split:
                              type: string
                              description: Dataset split name (train, test, validation)
                            row_index:
                              type: integer
                              description: Row index in the dataset
                            line:
                              type: string
                              description: The matched line content
                            line_number:
                              type: integer
                              description: Line number within the row
                            context:
                              type: array
                              items:
                                type: string
                              description: Context lines around the match
                            context_start_line:
                              type: integer
                        - type: object
                          title: DocGrepFileMatch
                          description: Grouped match for documentation
                          properties:
                            path:
                              type: string
                              description: Virtual path of the matched file
                            url:
                              type: string
                              description: Actual URL of the page
                            matches:
                              type: array
                              items:
                                type: object
                                properties:
                                  line_number:
                                    type: integer
                                  line:
                                    type: string
                                    description: The matched line
                                  context:
                                    type: array
                                    items:
                                      type: string
                                    description: Context lines around the match
                                  context_start_line:
                                    type: integer
                  files:
                    type: array
                    items:
                      type: string
                    description: List of file paths (when output_mode is 'files_with_matches')
                  counts:
                    type: object
                    additionalProperties:
                      type: integer
                    description: Match counts per file (when output_mode is 'count')
                  pattern:
                    type: string
                    description: The pattern that was searched
                  path_filter:
                    type: string
                    description: Path filter that was applied
                  total_matches:
                    type: integer
                  files_searched:
                    type: integer
                  files_with_matches:
                    type: integer
                    description: Number of files that contained matches
                  truncated:
                    type: boolean
                    description: Whether results were truncated due to limits
                  options:
                    type: object
                    description: Applied search options
                    properties:
                      case_sensitive:
                        type: boolean
                      whole_word:
                        type: boolean
                      lines_before:
                        type: integer
                      lines_after:
                        type: integer
                      output_mode:
                        type: string
        '400':
          description: Invalid regex pattern
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/rename:
    patch:
      summary: Rename a data source (Flexible)
      description: Update the display name of an indexed data source using flexible identifier (recommended)
      operationId: renameDataSource
      tags:
        - Data Sources
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenameRequestWithIdentifier'
      responses:
        '200':
          description: Data source renamed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  source_id:
                    type: string
                  display_name:
                    type: string
                  message:
                    type: string
        '400':
          description: Invalid request (e.g., empty name, identifier not found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /data-sources/{source_id}/category:
    patch:
      summary: Assign category to data source
      description: |
        Assign a category to a data source, or remove category by passing null.
        Works with all data source types (documentation, research papers, HuggingFace datasets).
      operationId: assignDataSourceCategory
      tags:
        - Data Sources
        - Categories
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
          description: |
            Flexible data source identifier. Can be:
            - UUID (e.g., "550e8400-e29b-41d4-a716-446655440000")
            - Display name (e.g., "Vercel AI SDK - Core")
            - URL (e.g., "https://docs.trynia.ai/")
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoryAssignRequest'
      responses:
        '200':
          description: Category assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  source_id:
                    type: string
                  category_id:
                    type: string
                    nullable: true
        '400':
          description: Invalid request (e.g., category not found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to data source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Data source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /categories:
    get:
      summary: List categories
      description: List all categories for the authenticated user/organization.
      operationId: listCategories
      tags:
        - Categories
      responses:
        '200':
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoriesListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
    post:
      summary: Create category
      description: Create a new category for organizing data sources.
      operationId: createCategory
      tags:
        - Categories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoryCreate'
      responses:
        '200':
          description: Category created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'
        '400':
          description: Invalid request (e.g., duplicate name)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /categories/{category_id}:
    patch:
      summary: Update category
      description: Update an existing category (name, color, or order).
      operationId: updateCategory
      tags:
        - Categories
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
          description: Category UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoryUpdate'
      responses:
        '200':
          description: Category updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'
        '400':
          description: Invalid request (e.g., duplicate name, no updates provided)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
    delete:
      summary: Delete category
      description: |
        Delete a category. Data sources with this category will become uncategorized.
      operationId: deleteCategory
      tags:
        - Categories
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
          description: Category UUID
      responses:
        '200':
          description: Category deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /research-papers:
    get:
      summary: List indexed research papers
      description: |
        List all research papers that have been indexed by the authenticated user.
        Returns paper metadata including arXiv ID, title, authors, and indexing status.
      operationId: listResearchPapers
      tags:
        - Research Papers
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of papers to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of papers to skip (for pagination)
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [processing, completed, failed]
          description: Filter by indexing status
      responses:
        '200':
          description: Research papers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  papers:
                    type: array
                    items:
                      $ref: '#/components/schemas/ResearchPaperResponse'
                  total:
                    type: integer
                    description: Total number of matching papers
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
    post:
      summary: Index a research paper
      description: |
        Index a research paper from arXiv. The paper's PDF is extracted,
        enriched with metadata from the arXiv API (title, authors, abstract, categories),
        and indexed into the vector store for semantic search.

        Supports multiple input formats:
        - Full arXiv URL: https://arxiv.org/abs/2312.00752
        - PDF URL: https://arxiv.org/pdf/2312.00752.pdf
        - Raw new-format ID: 2312.00752
        - Raw old-format ID: hep-th/9901001
        - With version: 2312.00752v1

        Papers are globally deduplicated - if another user has already indexed a paper,
        you'll get instant access to the existing index.
      operationId: indexResearchPaper
      tags:
        - Research Papers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResearchPaperRequest'
            examples:
              arxiv_id:
                summary: Using raw arXiv ID
                value:
                  url: "2312.00752"
              arxiv_url:
                summary: Using full arXiv URL
                value:
                  url: "https://arxiv.org/abs/2312.00752"
              arxiv_id_versioned:
                summary: Using versioned arXiv ID
                value:
                  url: "2312.00752v1"
              old_format:
                summary: Using old arXiv format
                value:
                  url: "hep-th/9901001"
      responses:
        '200':
          description: Research paper indexing started or completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResearchPaperResponse'
              examples:
                processing:
                  summary: Paper indexing started
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    arxiv_id: "2312.00752"
                    title: "Attention Is All You Need"
                    authors: ["Ashish Vaswani", "Noam Shazeer", "Niki Parmar"]
                    abstract: "The dominant sequence transduction models are based on complex recurrent or convolutional neural networks..."
                    categories: ["cs.CL", "cs.LG"]
                    primary_category: "cs.CL"
                    status: "processing"
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:30:00Z"
                    chunk_count: 0
                    pdf_url: "https://arxiv.org/pdf/2312.00752.pdf"
                    abs_url: "https://arxiv.org/abs/2312.00752"
                completed:
                  summary: Paper already indexed (instant access)
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    arxiv_id: "2312.00752"
                    title: "Attention Is All You Need"
                    authors: ["Ashish Vaswani", "Noam Shazeer", "Niki Parmar"]
                    abstract: "The dominant sequence transduction models are based on complex recurrent or convolutional neural networks..."
                    categories: ["cs.CL", "cs.LG"]
                    primary_category: "cs.CL"
                    status: "completed"
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:35:00Z"
                    chunk_count: 150
                    pdf_url: "https://arxiv.org/pdf/2312.00752.pdf"
                    abs_url: "https://arxiv.org/abs/2312.00752"
        '400':
          description: Invalid arXiv URL or ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid arXiv URL or ID: invalid-id. Expected formats: https://arxiv.org/abs/2312.00752, 2312.00752, or hep-th/9901001"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Paper not found on arXiv
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Paper not found on arXiv: 9999.99999. Please verify the ID is correct."
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Internal server error during indexing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /huggingface-datasets:
    get:
      summary: List indexed HuggingFace datasets
      description: |
        List all HuggingFace datasets that have been indexed by the authenticated user.
        Returns dataset metadata including splits, columns, row counts, and indexing status.
      operationId: listHuggingFaceDatasets
      tags:
        - HuggingFace Datasets
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of datasets to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of datasets to skip (for pagination)
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [processing, completed, failed]
          description: Filter by indexing status
        - name: organization_id
          in: query
          required: false
          schema:
            type: string
          description: Filter by organization ID
      responses:
        '200':
          description: HuggingFace datasets retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HuggingFaceDatasetListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
    post:
      summary: Index a HuggingFace dataset
      description: |
        Index a HuggingFace dataset for semantic search. The dataset is fetched from
        the HuggingFace Hub, text columns are extracted and chunked, and embeddings
        are created for semantic search.

        Supports multiple input formats:
        - Full URL: https://huggingface.co/datasets/squad
        - Owner/dataset format: dair-ai/emotion
        - Dataset name only: squad

        Large datasets are automatically sampled to manage storage and indexing time.
        Datasets are globally deduplicated - if another user has already indexed a dataset,
        you'll get instant access to the existing index.
      operationId: indexHuggingFaceDataset
      tags:
        - HuggingFace Datasets
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HuggingFaceDatasetRequest'
            examples:
              owner_dataset:
                summary: Using owner/dataset format
                value:
                  url: "dair-ai/emotion"
              full_url:
                summary: Using full HuggingFace URL
                value:
                  url: "https://huggingface.co/datasets/squad"
              dataset_name:
                summary: Using dataset name only
                value:
                  url: "squad"
              with_config:
                summary: With specific configuration
                value:
                  url: "glue"
                  config: "sst2"
      responses:
        '200':
          description: HuggingFace dataset indexing started or completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HuggingFaceDatasetResponse'
              examples:
                processing:
                  summary: Dataset indexing started
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    dataset_id: "emotion"
                    url: "https://huggingface.co/datasets/dair-ai/emotion"
                    status: "processing"
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:30:00Z"
                    owner: "dair-ai"
                    description: "Emotion is a dataset of English Twitter messages with six basic emotions."
                    splits: ["train", "test", "validation"]
                    columns: [{"name": "text", "dtype": "string"}, {"name": "label", "dtype": "int64"}]
                    row_count: 20000
                    indexed_row_count: 0
                    chunk_count: 0
                completed:
                  summary: Dataset already indexed (instant access)
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    dataset_id: "emotion"
                    url: "https://huggingface.co/datasets/dair-ai/emotion"
                    status: "completed"
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:35:00Z"
                    owner: "dair-ai"
                    description: "Emotion is a dataset of English Twitter messages with six basic emotions."
                    splits: ["train", "test", "validation"]
                    columns: [{"name": "text", "dtype": "string"}, {"name": "label", "dtype": "int64"}]
                    row_count: 20000
                    indexed_row_count: 20000
                    chunk_count: 500
                    sampling_strategy: "full"
        '400':
          description: Invalid HuggingFace dataset URL format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid HuggingFace dataset URL: invalid. Expected formats: https://huggingface.co/datasets/squad, squad, or owner/dataset"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Dataset not found on HuggingFace Hub
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Dataset not found or inaccessible: nonexistent/dataset"
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Internal server error during indexing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /global-sources/subscribe:
    post:
      summary: Subscribe to a global source
      description: |
        Subscribe to an existing globally indexed public source for instant access.

        This endpoint checks if a public source (repository, documentation, research paper,
        or HuggingFace dataset) is already indexed globally. If it is, it creates a local
        reference for the user so they can search it immediately without re-indexing.

        **Supported source types:**
        - **repository**: GitHub repositories (https://github.com/owner/repo)
        - **documentation**: Documentation websites (https://docs.example.com)
        - **research_paper**: arXiv papers (https://arxiv.org/abs/2312.00752 or 2312.00752)
        - **huggingface_dataset**: HuggingFace datasets (https://huggingface.co/datasets/squad or squad)

        **Behavior by source type:**
        - For repositories, documentation, and research papers: Returns instant_access if indexed,
          wait_for_indexing if currently being indexed, or not_indexed if not found.
        - For HuggingFace datasets: If not already indexed, automatically triggers indexing
          and returns indexing_started.

        Use this when you want to access a public source that may already be indexed by others.
        If the source is not yet indexed, use the appropriate index endpoint instead
        (e.g., POST /repositories, POST /data-sources, POST /research-papers, POST /huggingface-datasets).
      operationId: subscribeToGlobalSource
      tags:
        - Global Sources
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GlobalSourceSubscribeRequest'
            examples:
              github_repo:
                summary: Subscribe to a GitHub repository
                value:
                  url: "https://github.com/vercel/ai-sdk"
              github_repo_ref:
                summary: Subscribe to a GitHub repository ref
                value:
                  url: "https://github.com/vercel/ai-sdk"
                  ref: "v1.2.3"
              documentation:
                summary: Subscribe to documentation
                value:
                  url: "https://docs.anthropic.com"
              arxiv_paper:
                summary: Subscribe to an arXiv paper
                value:
                  url: "2312.00752"
              huggingface_dataset:
                summary: Subscribe to a HuggingFace dataset
                value:
                  url: "https://huggingface.co/datasets/squad"
                  source_type: "huggingface_dataset"
      responses:
        '200':
          description: Subscription processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalSourceSubscribeResponse'
              examples:
                instant_access:
                  summary: Source is indexed and ready
                  value:
                    action: "instant_access"
                    message: "Successfully subscribed to global repository. You can now search it immediately."
                    global_source_id: "github:vercel/ai-sdk"
                    namespace: "repo_vercel_ai-sdk"
                    status: "indexed"
                    local_reference_id: "proj_abc123"
                    display_name: "vercel/ai-sdk"
                wait_for_indexing:
                  summary: Source is being indexed
                  value:
                    action: "wait_for_indexing"
                    message: "Source is currently being indexed (status: indexing). You've been subscribed and will have access when complete."
                    global_source_id: "github:owner/repo"
                    namespace: "repo_owner_repo"
                    status: "indexing"
                    local_reference_id: null
                    display_name: "owner/repo"
                not_indexed:
                  summary: Source is not indexed
                  value:
                    action: "not_indexed"
                    message: "No global source found for this URL. Use the `index` tool to add it first."
                    global_source_id: null
                    namespace: null
                    status: null
                    local_reference_id: null
                    display_name: null
                indexing_started:
                  summary: HuggingFace dataset indexing started
                  value:
                    action: "indexing_started"
                    message: "HuggingFace dataset indexing started. Check back in a few minutes."
                    global_source_id: "hf:squad"
                    namespace: "hf_squad"
                    status: "indexing"
                    local_reference_id: "ds_xyz789"
                    display_name: "squad"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Subscription processing error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /package-search/grep:
    post:
      summary: Search package source code with regex
      description: |
        Execute a grep-style regex search over the source code of a public package.
        This endpoint is useful for deterministically finding specific code patterns in packages
        before implementing solutions that use external dependencies. Supports multiple package
        registries including npm, PyPI, crates.io, and Go modules.
      operationId: packageSearchGrep
      tags:
        - Package Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PackageSearchGrepRequest'
      responses:
        '200':
          description: Package search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PackageSearchResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Service error or package not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /package-search/hybrid:
    post:
      summary: Search package source code with semantic queries
      description: |
        Execute a hybrid semantic search over package source code using AI understanding
        and optional regex patterns. This allows for natural language queries about how
        packages implement specific features, combined with optional pre-filtering.
      operationId: packageSearchHybrid
      tags:
        - Package Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PackageSearchHybridRequest'
      responses:
        '200':
          description: Package search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PackageSearchResponse'
        '400':
          description: Invalid request parameters (e.g., too many semantic queries)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Service error or package not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /package-search/read-file:
    post:
      summary: Read specific lines from a package file
      description: |
        Read exact lines from a source file within a public package. This is useful for
        fetching complete file content when you already have the file SHA256 hash
        (typically obtained from grep or hybrid search results). Maximum 200 lines per request.
      operationId: packageSearchReadFile
      tags:
        - Package Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PackageSearchReadFileRequest'
      responses:
        '200':
          description: File content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  version_used:
                    type: string
                    description: Version of the package
                  file_path:
                    type: string
                    description: Path of the file within the package
                  start_line:
                    type: integer
                    description: Starting line number
                  end_line:
                    type: integer
                    description: Ending line number
                  content:
                    type: string
                    description: File content for the specified line range
                  total_lines:
                    type: integer
                    description: Total number of lines in the file
        '400':
          description: Invalid request parameters (e.g., invalid line range)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Service error or file not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle:
    post:
      summary: Oracle autonomous research agent (Pro only)
      description: |
        Execute comprehensive Oracle research using the full autonomous agent with extended thinking.
        
        The Oracle agent uses extended thinking capabilities to plan and execute multi-step
        research autonomously. It has access to a diverse set of tools including:
        - **Discovery**: list_repositories, list_documentation
        - **Web Research**: run_web_search, web_fetch (server-side)
        - **Code Search**: run_indexed_repo_search, code_grep, get_github_tree, read_source_content
        - **Documentation**: run_doc_search, doc_tree, doc_ls, doc_read, doc_grep
        
        The agent will iteratively search and analyze your indexed repositories and documentation,
        perform web searches for external context, and synthesize findings into a comprehensive report.
        
        **Note**: This is a long-running operation (typically 30-180 seconds). For real-time progress
        updates, use the streaming endpoint `/oracle/stream` instead.
      operationId: oracleResearch
      tags:
        - Oracle Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OracleResearchRequest'
      responses:
        '200':
          description: Research completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OracleResearchResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pro subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Research execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle/stream:
    post:
      summary: "[DEPRECATED] Oracle research with real-time streaming (Pro only)"
      deprecated: true
      description: |
        **DEPRECATED**: Use `/oracle/jobs` to create a job and `/oracle/jobs/{id}/stream` for streaming instead.
        The Jobs API provides better reliability, reconnection support, and job management.
        
        Execute Oracle research with Server-Sent Events (SSE) streaming for real-time progress updates.
        
        This endpoint streams research progress including:
        - **iteration_start**: New research iteration beginning
        - **tool_start**: Tool execution starting with action name and reason
        - **tool_complete**: Tool finished with success/failure status
        - **generating_report**: Final report synthesis starting
        - **complete**: Research finished with full result
        - **heartbeat**: Connection keep-alive (every 0.5s during idle)
        - **error**: Error occurred during research
        
        The Oracle agent uses extended thinking and has access to all tools including
        web search, code search, documentation search, and the doc filesystem tools
        (doc_tree, doc_ls, doc_read, doc_grep).
      operationId: oracleResearchStream
      tags:
        - Oracle Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OracleResearchRequest'
      responses:
        '200':
          description: SSE stream of research progress
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Stream of Server-Sent Events with JSON payloads. Event types:
                  - connected: Connection established
                  - iteration_start: {type, iteration}
                  - tool_start: {type, action, args, reason, iteration}
                  - tool_complete: {type, action, success, result_summary, iteration}
                  - generating_report: {type, message}
                  - complete: {type, result: OracleResearchResponse}
                  - error: {type, action, error, iteration}
                  - heartbeat: {type, timestamp}
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pro subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /oracle/sessions:
    get:
      summary: List Oracle research sessions
      description: List recent Oracle research sessions for the authenticated API key
      operationId: listOracleSessions
      tags:
        - Oracle Research
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of sessions to return
        - name: skip
          in: query
          schema:
            type: integer
            minimum: 0
            maximum: 500
            default: 0
          description: Number of sessions to skip (for pagination)
      responses:
        '200':
          description: Session list retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/OracleSessionSummary'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /oracle/sessions/{session_id}:
    get:
      summary: Get Oracle research session details
      description: Retrieve full details of a specific Oracle research session
      operationId: getOracleSessionDetail
      tags:
        - Oracle Research
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID to retrieve
      responses:
        '200':
          description: Session details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OracleSessionDetails'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle/sessions/{session_id}/messages:
    get:
      summary: Get Oracle session chat messages
      description: |
        Get chat messages for an Oracle research session, including the original query/report and follow-up messages.
      operationId: getOracleSessionMessages
      tags:
        - Oracle Research
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID to retrieve messages for
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
          description: Maximum number of stored messages to include
      responses:
        '200':
          description: Messages retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OracleSessionMessagesResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle/sessions/{session_id}/chat/stream:
    post:
      summary: Stream a follow-up chat answer for an Oracle session (SSE)
      description: |
        Stream a follow-up chat response for a completed Oracle research session.
        This is a lightweight tool-using follow-up mode (not a full Oracle research run).
      operationId: streamOracleSessionChat
      tags:
        - Oracle Research
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID to chat with
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OracleSessionChatRequest'
      responses:
        '200':
          description: SSE stream of follow-up chat events and content chunks
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Stream of Server-Sent Events with JSON payloads. Typical event types:
                  - tool_start / tool_complete (OracleAgent events)
                  - content: {type, content} (answer chunks)
                  - done: {type, session_id}
                  - error: {type, error}
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pro subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /oracle/jobs:
    post:
      summary: Create Oracle research job (Pro only)
      description: |
        Create a new Oracle research job that runs asynchronously.
        
        This is the recommended way to run Oracle research as it:
        - Queues jobs for reliable execution
        - Supports concurrency limits per user
        - Enables reconnection to running jobs
        - Provides job status tracking and history
        
        After creating a job, subscribe to `/oracle/jobs/{job_id}/stream` for real-time progress.
      operationId: createOracleJob
      tags:
        - Oracle Research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OracleResearchRequest'
      responses:
        '200':
          description: Job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    description: Unique job identifier
                  session_id:
                    type: string
                    description: Research session identifier
                  status:
                    type: string
                    enum: [queued, running]
                    description: Initial job status
                  message:
                    type: string
                    description: Status message
                  created_at:
                    type: string
                    format: date-time
                    description: When the job was created
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pro subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to create job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: List Oracle research jobs
      description: List Oracle research jobs for the authenticated user with optional status filtering
      operationId: listOracleJobs
      tags:
        - Oracle Research
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [queued, running, completed, failed, cancelled]
          description: Filter jobs by status
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of jobs to return
        - name: skip
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of jobs to skip (for pagination)
      responses:
        '200':
          description: Jobs list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      type: object
                      properties:
                        job_id:
                          type: string
                        session_id:
                          type: string
                        query:
                          type: string
                        status:
                          type: string
                          enum: [queued, running, completed, failed, cancelled]
                        created_at:
                          type: string
                          format: date-time
                        updated_at:
                          type: string
                          format: date-time
                        iterations:
                          type: integer
                        duration_ms:
                          type: integer
                        error:
                          type: string
                  total:
                    type: integer
                  limit:
                    type: integer
                  skip:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /oracle/jobs/{job_id}:
    get:
      summary: Get Oracle job status and result
      description: |
        Retrieve the current status and result of an Oracle research job.
        
        For completed jobs, includes the full research report and citations.
        For running jobs, shows progress information.
      operationId: getOracleJob
      tags:
        - Oracle Research
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
          description: Job identifier
      responses:
        '200':
          description: Job details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                  session_id:
                    type: string
                  query:
                    type: string
                  status:
                    type: string
                    enum: [queued, running, completed, failed, cancelled]
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                  final_report:
                    type: string
                    description: Research report (only for completed jobs)
                  citations:
                    type: array
                    items:
                      type: object
                    description: Source citations (only for completed jobs)
                  tool_calls:
                    type: array
                    items:
                      type: object
                    description: Tool execution log (only for completed jobs)
                  iterations:
                    type: integer
                  duration_ms:
                    type: integer
                  error:
                    type: string
                    description: Error message (only for failed jobs)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to this job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
    delete:
      summary: Cancel Oracle research job
      description: |
        Cancel a running or queued Oracle research job.
        
        Cancellation is best-effort - the job may complete before cancellation takes effect.
        Jobs that are already completed, failed, or cancelled cannot be cancelled again.
      operationId: cancelOracleJob
      tags:
        - Oracle Research
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
          description: Job identifier to cancel
      responses:
        '200':
          description: Job cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                  session_id:
                    type: string
                  status:
                    type: string
                    enum: [cancelled]
                  message:
                    type: string
        '400':
          description: Job cannot be cancelled (already completed/failed/cancelled)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to this job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to cancel job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle/jobs/{job_id}/stream:
    get:
      summary: Stream Oracle job events (SSE)
      description: |
        Subscribe to real-time progress updates for an Oracle research job via Server-Sent Events.
        
        This endpoint supports reconnection - you can subscribe to a running job at any time
        to receive remaining events. For completed jobs, returns the final result immediately.
        
        **Event types:**
        - `connected`: Connection established with session info
        - `started`: Research job has started
        - `iteration_start`: New research iteration beginning
        - `tool_start`: Tool execution starting (includes action, args, reason)
        - `tool_complete`: Tool finished (includes success status)
        - `generating_report`: Final report synthesis starting
        - `complete`: Research finished with full result
        - `error`: Error occurred
        - `workflow_event`: Workflow state change
      operationId: streamOracleJob
      tags:
        - Oracle Research
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
          description: Job identifier to stream
      responses:
        '200':
          description: SSE stream of job events
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Stream of Server-Sent Events with JSON payloads:
                  
                  ```
                  data: {"type": "connected", "job_id": "...", "session_id": "...", "timestamp": "..."}
                  
                  data: {"type": "tool_start", "action": "run_doc_search", "args": {...}, "reason": "...", "iteration": 1}
                  
                  data: {"type": "tool_complete", "action": "run_doc_search", "success": true, "result_summary": "...", "iteration": 1}
                  
                  data: {"type": "complete", "session_id": "...", "result": {...}}
                  ```
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Access denied to this job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /contexts:
    post:
      summary: Save conversation context
      description: |
        Save a new conversation context for cross-agent sharing.
        Contexts are stored and indexed in a vector store for semantic search.
        Supports organization-level contexts for team collaboration.
      operationId: saveContext
      tags:
        - Context Sharing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContextShareRequest'
      responses:
        '200':
          description: Context saved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextShareResponse'
        '400':
          description: Invalid request (e.g., content too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to save context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: List conversation contexts
      description: |
        List user's conversation contexts with pagination and filtering.
        Supports filtering by tags, agent source, and organization.
        Returns contexts sorted by creation date (newest first).
      operationId: listContexts
      tags:
        - Context Sharing
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of contexts to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of contexts to skip (for pagination)
        - name: tags
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated tags to filter by
        - name: agent_source
          in: query
          required: false
          schema:
            type: string
          description: Filter by agent source (e.g., "cursor", "claude-code")
        - name: memory_type
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/MemoryType'
          description: Filter by memory type (scratchpad, episodic, fact, procedural)
      responses:
        '200':
          description: Contexts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  contexts:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContextShareResponse'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                        description: Total number of contexts matching filters
                      limit:
                        type: integer
                      offset:
                        type: integer
                      has_more:
                        type: boolean
                        description: Whether there are more contexts to fetch
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to list contexts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /contexts/search:
    get:
      summary: Text search contexts
      description: |
        Search conversation contexts by content, title, summary, or tags using MongoDB text search.
        This is a simpler, faster alternative to semantic search for exact matches.
      operationId: searchContexts
      tags:
        - Context Sharing
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
          description: Search query
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of results
        - name: tags
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated tags to filter by
        - name: agent_source
          in: query
          required: false
          schema:
            type: string
          description: Filter by agent source
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  contexts:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContextShareResponse'
                  search_query:
                    type: string
                  total_results:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Search failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /contexts/semantic-search:
    get:
      summary: Semantic search contexts
      description: |
        Semantic search conversation contexts using vector embeddings and hybrid (vector + BM25) search.
        Uses vector store for fast similarity search across context content.
        Returns results ranked by relevance with optional match highlights and workspace filtering.
      operationId: semanticSearchContexts
      tags:
        - Context Sharing
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
          description: Search query
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of results
        - name: include_highlights
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Include match highlights in results
        - name: workspace_filter
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific workspace name
      responses:
        '200':
          description: Semantic search completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/ContextShareResponse'
                        - type: object
                          properties:
                            relevance_score:
                              type: number
                              description: Relevance score from vector search (0-1)
                            match_metadata:
                              type: object
                              properties:
                                search_type:
                                  type: string
                                  enum: [hybrid]
                                vector_score:
                                  type: number
                                rank:
                                  type: integer
                            match_highlights:
                              type: array
                              items:
                                type: string
                              description: Highlighted matches from content
                            files_edited:
                              type: array
                              items:
                                type: string
                              description: Paths of edited files (up to 5)
                            workspace_name:
                              type: string
                              description: Workspace/project name
                  search_query:
                    type: string
                  search_metadata:
                    type: object
                    properties:
                      search_type:
                        type: string
                      total_results:
                        type: integer
                      vector_matches:
                        type: integer
                      mongodb_matches:
                        type: integer
                  suggestions:
                    type: object
                    properties:
                      related_tags:
                        type: array
                        items:
                          type: string
                      workspaces:
                        type: array
                        items:
                          type: string
                      tips:
                        type: array
                        items:
                          type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '503':
          description: Vector store not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Semantic search error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /contexts/{context_id}:
    get:
      summary: Get conversation context
      description: |
        Retrieve a specific conversation context by ID.
        Returns full context details including content, metadata, NIA references, and edited files.
      operationId: getContext
      tags:
        - Context Sharing
      parameters:
        - name: context_id
          in: path
          required: true
          schema:
            type: string
          description: Unique context identifier
      responses:
        '200':
          description: Context retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextShareResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Context not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to retrieve context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      summary: Update conversation context
      description: |
        Update an existing conversation context.
        All fields are optional - only provided fields will be updated.
        The context is re-indexed in the vector store if content fields are updated.
      operationId: updateContext
      tags:
        - Context Sharing
      parameters:
        - name: context_id
          in: path
          required: true
          schema:
            type: string
          description: Unique context identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContextShareUpdateRequest'
      responses:
        '200':
          description: Context updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextShareResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Context not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to update context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete conversation context
      description: |
        Delete a conversation context (soft delete).
        The context is marked as inactive but not permanently deleted from the database.
      operationId: deleteContext
      tags:
        - Context Sharing
      parameters:
        - name: context_id
          in: path
          required: true
          schema:
            type: string
          description: Unique context identifier
      responses:
        '200':
          description: Context deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Context not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to delete context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /usage:
    get:
      summary: Get usage summary
      description: |
        Get the current user's usage summary for the current billing period.
        
        Returns usage counts and limits for all metered operations including:
        - **queries**: Search, grep, doc_read, read_source_content operations
        - **deep_research**: Deep research agent usage
        - **web_search**: Web search operations
        - **package_search**: Package source code search
        - **oracle**: Oracle research agent usage
        - **contexts**: Context sharing operations
        - **indexing**: Repository and documentation indexing
        
        Free tier users have monthly limits on certain operations.
        Pro users have unlimited usage for most operations.
      operationId: getUsageSummary
      tags:
        - Usage
      responses:
        '200':
          description: Usage summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageSummaryResponse'
              example:
                user_id: "user_abc123"
                subscription_tier: "free"
                billing_period_start: "2024-01-01T00:00:00Z"
                billing_period_end: "2024-02-01T00:00:00Z"
                usage:
                  queries:
                    used: 45
                    limit: 100
                    unlimited: false
                  deep_research:
                    used: 0
                    limit: 0
                    unlimited: false
                  indexing:
                    used: 2
                    limit: 5
                    unlimited: false
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Failed to fetch usage summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dependencies/analyze:
    post:
      summary: Analyze package manifest
      description: |
        Parse a package manifest and return dependency information with documentation URL mappings.
        This is a preview - no subscriptions are created.

        Supports: package.json, requirements.txt, pyproject.toml, Cargo.toml, go.mod, Gemfile

        Returns dependency list with mapped documentation URLs using 3-tier strategy:
        1. Curated static mapping (instant, 100% confidence)
        2. Registry API lookup (fast, 90% confidence)
        3. AI inference (slower, varies confidence)
      operationId: analyzeDependencies
      tags:
        - Dependencies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DependencyAnalyzeRequest'
      responses:
        '200':
          description: Dependencies analyzed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyzeResponse'
        '400':
          description: Invalid manifest content or type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to analyze manifest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dependencies/subscribe:
    post:
      summary: Subscribe to documentation for manifest dependencies
      description: |
        Parse a package manifest and automatically subscribe to documentation for all dependencies.

        For each dependency:
        1. Map package name to documentation URL (curated  registry API  AI)
        2. Check if documentation is already indexed globally
        3. If indexed: instant access
        4. If indexing: subscribe and wait
        5. If not indexed: start indexing (up to max_new_indexes)

        Returns categorized results showing what happened to each dependency.
      operationId: subscribeDependencies
      tags:
        - Dependencies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DependencySubscribeRequest'
      responses:
        '200':
          description: Subscription completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscribeResponse'
        '400':
          description: Invalid manifest content or type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to subscribe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dependencies/upload:
    post:
      summary: Upload manifest file and subscribe to dependencies
      description: |
        Upload a package manifest file and subscribe to documentation for all dependencies.
        Accepts multipart form data with the manifest file.
      operationId: uploadDependencies
      tags:
        - Dependencies
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Manifest file to upload
                include_dev_dependencies:
                  type: boolean
                  default: false
                  description: Include dev dependencies
                max_new_indexes:
                  type: integer
                  minimum: 0
                  maximum: 500
                  default: 150
                  description: Max new indexes to start
      responses:
        '200':
          description: Subscription completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscribeResponse'
        '400':
          description: Invalid file or content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to process upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /advisor:
    post:
      summary: Context-aware code advisor
      description: |
        Analyze codebase context against Nia's indexed documentation to get tailored recommendations.

        Takes structured codebase context (files, dependencies, etc.) and a query,
        searches relevant documentation, and returns tailored advice that maps
        documentation to the user's specific code.
      operationId: advisorAnalyze
      tags:
        - Advisor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdvisorRequest'
      responses:
        '200':
          description: Analysis completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdvisorResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          description: Failed to analyze
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===========================================================================
  # Local Folders - Private, user-scoped file storage and search
  # ===========================================================================

  /local-folders:
    post:
      summary: Create and index a local folder
      description: |
        Upload local folder files for private indexing. Local folders are user-scoped and never public.

        **Usage:**
        - Send file contents directly in the request body
        - Files are validated, chunked, and indexed for semantic search
        - Use with `/search/query` endpoint with `local_folders` parameter to search

        **Limits:**
        - Max 1000 files per folder
        - Max 5MB per file
        - Max 100MB total per folder
      operationId: createLocalFolder
      tags:
        - Local Folders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLocalFolderRequest'
      responses:
        '200':
          description: Local folder created and indexing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderItem'
        '400':
          description: Invalid request (no files, too many files, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

    get:
      summary: List local folders
      description: List all local folders for the authenticated user.
      operationId: listLocalFolders
      tags:
        - Local Folders
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Maximum folders to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
        - name: status
          in: query
          schema:
            type: string
            enum: [processing, completed, indexed, failed]
          description: Filter by status
      responses:
        '200':
          description: List of local folders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}:
    get:
      summary: Get local folder details
      description: Get details of a specific local folder.
      operationId: getLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: Local folder details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderItem'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    delete:
      summary: Delete local folder
      description: Delete a local folder and all its indexed content.
      operationId: deleteLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: Local folder deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/rename:
    patch:
      summary: Rename local folder
      description: Update the display name of a local folder.
      operationId: renameLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenameLocalFolderRequest'
      responses:
        '200':
          description: Local folder renamed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderItem'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/tree:
    get:
      summary: Get local folder file tree
      description: Get the file tree structure of a local folder.
      operationId: getLocalFolderTree
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: File tree
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderTreeResponse'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/ls:
    get:
      summary: List directory contents
      description: List files in a specific directory path within the local folder.
      operationId: listLocalFolderDirectory
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
        - name: path
          in: query
          schema:
            type: string
            default: "/"
          description: Directory path to list
      responses:
        '200':
          description: Directory listing
          content:
            application/json:
              schema:
                type: object
                properties:
                  path:
                    type: string
                  entries:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        type:
                          type: string
                          enum: [file, directory]
                        size:
                          type: integer
        '404':
          description: Local folder or path not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/read:
    get:
      summary: Read file content
      description: Read the content of a file within the local folder.
      operationId: readLocalFolderFile
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: File path to read
        - name: line_start
          in: query
          schema:
            type: integer
          description: Start line (1-indexed)
        - name: line_end
          in: query
          schema:
            type: integer
          description: End line (1-indexed)
      responses:
        '200':
          description: File content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderReadResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/grep:
    post:
      summary: Search in local folder
      description: Search for a pattern across all files in the local folder using regex.
      operationId: grepLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocalFolderGrepRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderGrepResponse'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/classify:
    post:
      summary: Start classification
      description: Start AI-powered classification of files in the local folder into categories.
      operationId: classifyLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: Classification started
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/classification:
    get:
      summary: Get classification status
      description: Get the classification status and results for a local folder.
      operationId: getLocalFolderClassification
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: Classification info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassificationInfo'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/classification/items:
    get:
      summary: Get classified items
      description: Get items classified into a specific category.
      operationId: getLocalFolderClassifiedItems
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Maximum items to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: Classified items
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        chunk_id:
                          type: string
                        category:
                          type: string
                        content_preview:
                          type: string
                        file_path:
                          type: string
                  total:
                    type: integer
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/sync:
    post:
      summary: Sync local folder
      description: Trigger a sync of the local folder content with updated files.
      operationId: syncLocalFolder
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - files
              properties:
                files:
                  type: array
                  items:
                    $ref: '#/components/schemas/FileItem'
                  description: Updated file contents
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/sync-upload:
    post:
      summary: Sync with database upload
      description: |
        Sync a database-type local folder by uploading the database file.
        Extracts only new content since last sync using stored cursor.
      operationId: syncLocalFolderWithUpload
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DatabaseUploadRequest'
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          description: Not a database folder or invalid database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/{local_folder_id}/continuous-sync:
    get:
      summary: Get continuous sync status
      description: Get the continuous sync configuration and status for a local folder.
      operationId: getLocalFolderContinuousSync
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      responses:
        '200':
          description: Continuous sync info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContinuousSyncInfo'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    patch:
      summary: Update continuous sync settings
      description: Enable or disable continuous sync for a local folder.
      operationId: updateLocalFolderContinuousSync
      tags:
        - Local Folders
      parameters:
        - name: local_folder_id
          in: path
          required: true
          schema:
            type: string
          description: Local folder ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContinuousSyncUpdateRequest'
      responses:
        '200':
          description: Continuous sync updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContinuousSyncInfo'
        '404':
          description: Local folder not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /local-folders/from-database:
    post:
      summary: Create from database
      description: |
        Create a local folder by extracting text from a SQLite database.
        Supports iMessage, WhatsApp, and generic SQLite databases.
      operationId: createLocalFolderFromDatabase
      tags:
        - Local Folders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDatabaseFolderRequest'
      responses:
        '200':
          description: Local folder created from database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalFolderItem'
        '400':
          description: Invalid database or unsupported format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /local-folders/preview-db:
    post:
      summary: Preview database content
      description: Preview tables and sample content from a SQLite database before creating a local folder.
      operationId: previewDatabase
      tags:
        - Local Folders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DatabaseUploadRequest'
      responses:
        '200':
          description: Database preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  tables:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        row_count:
                          type: integer
                        columns:
                          type: array
                          items:
                            type: string
                  sample_content:
                    type: array
                    items:
                      type: string
                  detected_type:
                    type: string
                    description: Auto-detected database type (imessage, whatsapp, generic)
        '400':
          description: Invalid database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

tags:
  - name: Sources
    description: Unified source management (repositories, documentation, research papers, datasets, local folders)
  - name: Search
    description: Unified search endpoint with mode discriminator
  - name: Repositories
    description: GitHub repository indexing and operations (tree, content, grep)
  - name: Query
    description: AI-powered code and documentation querying operations
  - name: Data Sources
    description: |
      Unified operations for documentation, research papers, and HuggingFace datasets.
      All three source types share the same endpoints for tree, read, grep, and ls operations.
      Use source_type filter when listing to filter by type.
  - name: Research Papers
    description: Index research papers from arXiv. Once indexed, use Data Sources endpoints for tree/read/grep.
  - name: HuggingFace Datasets
    description: Index HuggingFace datasets. Once indexed, use Data Sources endpoints for tree/read/grep.
  - name: Global Sources
    description: Subscribe to globally indexed public sources (repos, docs, papers, datasets) for instant access without re-indexing
  - name: Search & Research
    description: Web search, deep research, and universal search operations
  - name: Package Search
    description: Package source code search across npm, PyPI, crates.io, and Go modules
  - name: Context Sharing
    description: Cross-agent conversation context sharing with vector search capabilities
  - name: Oracle Research
    description: Autonomous AI research agent with extended thinking, web search, code analysis, and documentation exploration capabilities
  - name: Usage
    description: API usage tracking and billing information
  - name: Dependencies
    description: Package manifest analysis and documentation subscription for dependencies
  - name: Advisor
    description: Context-aware code advisor that analyzes your codebase against indexed documentation
  - name: Local Folders
    description: |
      Private, user-scoped file storage and semantic search.

      Local folders allow you to upload and index personal files (notes, documents, code) for AI-powered search.
      Unlike other sources, local folders are never public and are isolated per user.

      **Key features:**
      - Upload files directly via API (no filesystem access required)
      - Semantic search with the `/search/query` endpoint using `local_folders` parameter
      - File operations: tree, ls, read, grep
      - AI-powered classification into categories
      - Database import (iMessage, WhatsApp, SQLite)
      - Continuous sync support
